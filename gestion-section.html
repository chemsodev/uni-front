<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Sections</title>
    <link href="style/gestion-section.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div id="navbar-container"></div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header header-actions">
                <h1 class="page-title">Gestion des Sections</h1>
            </div>
            
            <div class="card">
                <h2 class="card-title">Mes Sections</h2>
                
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Rechercher une section...">
                        <button onclick="filterSections()">üîç</button>
                    </div>
                </div>
                
                <div class="sections-list" id="sectionsList">
                    <!-- Les sections seront charg√©es dynamiquement ici -->
                    <div class="loading-message">Chargement des sections...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const API_BASE_URL = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('enseignant_token') || sessionStorage.getItem('enseignant_token');
        let currentUser = null;
        let sectionsData = [];
        let studentsData = {};

        document.addEventListener("DOMContentLoaded", async function () {
            // Charger la navigation
            await loadNavigation();
            
            // V√©rifier l'authentification
            if (!await verifyAuth()) {
                window.location.href = 'enseignant-login.html';
                return;
            }

            // Charger les donn√©es
            await loadData();
        });

        async function loadNavigation() {
            try {
                const response = await fetch("enseignant-nav.html");
                const html = await response.text();
                document.getElementById("navbar-container").innerHTML = html;
                
                // Marquer le lien actif
                const navScript = document.createElement("script");
                navScript.innerHTML = `
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                        if(link.getAttribute('href') === '${window.location.pathname.split("/").pop()}') {
                            link.classList.add('active');
                        }
                    });
                `;
                document.body.appendChild(navScript);
            } catch (error) {
                console.error("Erreur de chargement de la navigation:", error);
            }
        }

        async function verifyAuth() {
            if (!authToken) return false;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    method: "GET",
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) return false;
                
                const userData = await response.json();
                if (userData.adminRole !== "enseignant") return false;
                
                currentUser = {
                    id: userData.userId,
                    email: userData.email
                };
                return true;
            } catch (error) {
                console.error("Erreur de v√©rification d'authentification:", error);
                return false;
            }
        }

        async function loadData() {
            try {
                // Charger les sections de l'enseignant
                const response = await fetch(`${API_BASE_URL}/enseignants/${currentUser.id}/sections`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error("Erreur de chargement des sections");

                sectionsData = await response.json();
                renderSections(sectionsData);
            } catch (error) {
                console.error("Erreur de chargement des donn√©es:", error);
                showError("Erreur de chargement des donn√©es. Veuillez r√©essayer.");
            }
        }

        function renderSections(sections) {
            const container = document.getElementById("sectionsList");
            
            if (!sections || sections.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune section disponible</div>';
                return;
            }
            
            container.innerHTML = '';
            
            sections.forEach(section => {
                const sectionItem = document.createElement("div");
                sectionItem.className = "section-item";
                sectionItem.innerHTML = `
                    <div class="section-info">
                        <div class="section-name">${section.filiere} - Section ${section.nom}</div>
                        <div class="section-details">Module: ${section.module || 'Non sp√©cifi√©'} | Semestre ${section.semestre || 'Non sp√©cifi√©'}</div>
                    </div>
                    <div class="student-count">${section.nombreEtudiants || 0} √©tudiants</div>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="loadStudents('${section.id}')">Voir √©tudiants</button>
                        <button class="btn btn-primary" onclick="manageSection('${section.id}')">G√©rer</button>
                    </div>
                `;
                
                container.appendChild(sectionItem);
            });
        }

        async function loadStudents(sectionId) {
            try {
                // V√©rifier si les √©tudiants sont d√©j√† charg√©s
                if (!studentsData[sectionId]) {
                    const response = await fetch(`${API_BASE_URL}/sections/${sectionId}/etudiants`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (!response.ok) throw new Error("Erreur de chargement des √©tudiants");

                    studentsData[sectionId] = await response.json();
                }

                // Afficher le panneau des √©tudiants
                showStudentsPanel(sectionId);
            } catch (error) {
                console.error("Erreur de chargement des √©tudiants:", error);
                showError("Erreur de chargement des √©tudiants. Veuillez r√©essayer.");
            }
        }

        function showStudentsPanel(sectionId) {
            // Trouver la section correspondante
            const section = sectionsData.find(s => s.id === sectionId);
            if (!section) return;

            // Cr√©er ou mettre √† jour le panneau des √©tudiants
            let panel = document.getElementById(`students-panel-${sectionId}`);
            
            if (!panel) {
                panel = document.createElement("div");
                panel.className = "student-panel";
                panel.id = `students-panel-${sectionId}`;
                document.getElementById("sectionsList").appendChild(panel);
            }

            panel.innerHTML = `
                <div class="panel-header">
                    <div class="panel-title">√âtudiants - ${section.filiere} Section ${section.nom}</div>
                    <button class="btn btn-secondary" onclick="closeStudentsPanel('${sectionId}')">Fermer</button>
                </div>
                <div class="student-list">
                    ${renderStudentsList(studentsData[sectionId])}
                </div>
            `;

            panel.style.display = 'block';
        }

        function renderStudentsList(students) {
            if (!students || students.length === 0) {
                return '<div class="empty-state">Aucun √©tudiant dans cette section</div>';
            }

            return students.map(student => `
                <div class="student-item">
                    <div class="student-name">${student.prenom} ${student.nom}</div>
                    <div class="student-group">TD${student.groupe_td} / TP${student.groupe_tp}</div>
                    <div class="student-actions">
                        <button class="btn btn-small" onclick="viewStudentDetails('${student.id}')">D√©tails</button>
                    </div>
                </div>
            `).join('');
        }

        function closeStudentsPanel(sectionId) {
            const panel = document.getElementById(`students-panel-${sectionId}`);
            if (panel) {
                panel.style.display = 'none';
            }
        }

        function filterSections() {
            const searchTerm = document.getElementById("searchInput").value.toLowerCase();
            
            if (!searchTerm) {
                renderSections(sectionsData);
                return;
            }
            
            const filtered = sectionsData.filter(section => 
                section.filiere.toLowerCase().includes(searchTerm) || 
                section.nom.toLowerCase().includes(searchTerm) ||
                (section.module && section.module.toLowerCase().includes(searchTerm))
            );
            
            renderSections(filtered);
        }

        function manageSection(sectionId) {
            // Redirection vers la page de gestion de section
            window.location.href = `gestion-section-details.html?sectionId=${sectionId}`;
        }

        function viewStudentDetails(studentId) {
            // Redirection vers la page de d√©tails de l'√©tudiant
            window.location.href = `etudiant-details.html?studentId=${studentId}`;
        }

        function showError(message) {
            const container = document.getElementById("sectionsList");
            container.innerHTML = `
                <div class="error-message">
                    ${message}
                    <button onclick="location.reload()">R√©essayer</button>
                </div>
            `;
        }
    </script>
</body>
</html>
