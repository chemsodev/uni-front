<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Notifications</title>
    <link href="style/notification.css" rel="stylesheet" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div id="navbar-container"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">Notifications</h1>
          <div class="header-actions">
            <button onclick="markAllAsRead()">Tout marquer comme lu</button>
          </div>
        </div>

        <!-- Contenu principal -->
        <div class="content-card">
          <div class="card-title">
            <span>Mes notifications</span>
            <div class="card-title-actions">
              <button class="filter-btn" onclick="deleteAllRead()">
                Supprimer lues
              </button>
            </div>
          </div>

          <div class="notification-filters">
            <button
              class="filter-btn active"
              onclick="filterNotifications('all')"
            >
              Toutes
            </button>
            <button class="filter-btn" onclick="filterNotifications('admin')">
              Administration
            </button>
            <button class="filter-btn" onclick="filterNotifications('cours')">
              Cours
            </button>
            <button class="filter-btn" onclick="filterNotifications('examen')">
              Examens
            </button>
            <button class="filter-btn" onclick="filterNotifications('unread')">
              Non lues
            </button>
          </div>

          <div class="notification-list" id="notification-list">
            <!-- Template d'une seule notification -->
            <div
              class="notification-item unread admin"
              data-type="admin"
              data-read="false"
              id="notification-template"
              style="display: none"
            >
              <div class="notification-badge"></div>
              <div class="notification-header">
                <div class="notification-title">
                  <span class="notification-icon icon-admin">A</span>
                  <span class="notification-title-text"
                    >Titre de la notification</span
                  >
                </div>
                <div class="notification-date">Date de la notification</div>
              </div>
              <div class="notification-content">
                Contenu de la notification...
              </div>
              <div class="notification-actions">
                <button class="notification-btn" onclick="markAsRead(this)">
                  Marquer comme lu
                </button>
                <button
                  class="notification-btn primary"
                  onclick="viewDetails('ID')"
                >
                  Action
                </button>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button class="pagination-btn">&laquo;</button>
            <button class="pagination-btn active">1</button>
            <button class="pagination-btn">2</button>
            <button class="pagination-btn">3</button>
            <button class="pagination-btn">&raquo;</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Global variables
      let currentUser = null;
      let authToken = null;

      // Donnees des notifications
      const notificationsData = [
        {
          id: "DEM-2546",
          type: "admin",
          read: false,
          icon: "A",
          iconClass: "icon-admin",
          title: "Mise à jour de votre demande de changement de groupe TD",
          date: "12/04/2025 • 09:15",
          content:
            "Votre demande de changement de groupe TD (DEM-2546) a été examinée et est actuellement en cours de traitement par l'administration. Vous recevrez une réponse dans les prochains jours.",
          actionText: "Voir détails",
          actionFunction: "viewDetails('DEM-2546')",
        },
        {
          id: "ALG-425",
          type: "cours",
          read: false,
          icon: "C",
          iconClass: "icon-cours",
          title: "Modification d'horaire - Cours d'Algorithmique",
          date: "11/04/2025 • 14:30",
          content:
            "Le cours d'Algorithmique prévu le 15/04/2025 à 10:00 est exceptionnellement déplacé à 13:30 dans la salle B204. Veuillez ajuster votre emploi du temps en conséquence.",
          actionText: "Voir calendrier",
          actionFunction: "viewCalendar('ALG-425')",
        },
        {
          id: "MAT-125",
          type: "examen",
          read: false,
          icon: "E",
          iconClass: "icon-examen",
          title: "Publication des résultats - Examen de Mathématiques",
          date: "10/04/2025 • 16:45",
          content:
            "Les résultats de l'examen de Mathématiques du 01/04/2025 sont désormais disponibles. Vous pouvez consulter votre note et le corrigé dans la section 'Notes et Résultats' de votre espace étudiant.",
          actionText: "Voir résultats",
          actionFunction: "viewResults('MAT-125')",
        },
        {
          id: "DEM-2498",
          type: "admin",
          read: false,
          icon: "A",
          iconClass: "icon-admin",
          title: "Changement de section approuvé",
          date: "08/04/2025 • 11:20",
          content:
            "Votre demande de changement de section (DEM-2498) a été approuvée. Vous êtes désormais affecté à la Section B. Ce changement sera effectif à partir du 10/04/2025. Veuillez consulter votre nouvel emploi du temps.",
          actionText: "Voir emploi du temps",
          actionFunction: "viewSchedule()",
        },
        {
          id: "SD-215",
          type: "cours",
          read: false,
          icon: "C",
          iconClass: "icon-cours",
          title: "Nouveau document - Cours de Structures de Données",
          date: "07/04/2025 • 09:35",
          content:
            "Un nouveau support de cours intitulé 'Introduction aux Arbres Binaires' a été mis en ligne pour le module de Structures de Données. Vous pouvez le télécharger depuis la plateforme de cours.",
          actionText: "Voir document",
          actionFunction: "viewDocument('SD-215')",
        },
        {
          id: "BD-102",
          type: "cours",
          read: true,
          icon: "C",
          iconClass: "icon-cours",
          title: "Annulation de séance - TP Bases de Données",
          date: "05/04/2025 • 13:10",
          content:
            "La séance de TP de Bases de Données prévue le 07/04/2025 à 14:00 est annulée en raison de l'indisponibilité du professeur. Une séance de rattrapage sera programmée ultérieurement.",
          actionText: null,
          actionFunction: null,
        },
        {
          id: "POO-EX1",
          type: "examen",
          read: true,
          icon: "E",
          iconClass: "icon-examen",
          title: "Rappel - Examen de Programmation Orientée Objet",
          date: "03/04/2025 • 10:25",
          content:
            "Rappel : l'examen de Programmation Orientée Objet aura lieu le 20/04/2025 à 09:00 en salle A310. N'oubliez pas d'apporter votre carte d'étudiant et vos fournitures. Les calculatrices ne sont pas autorisées.",
          actionText: "Ajouter au calendrier",
          actionFunction: "addToCalendar('POO-EX1')",
        },
        {
          id: "INSCRIPTION",
          type: "admin",
          read: true,
          icon: "A",
          iconClass: "icon-admin",
          title: "Confirmation de votre inscription",
          date: "01/04/2025 • 08:50",
          content:
            "Votre inscription pour l'année académique 2024-2025 a été confirmée. Vous pouvez désormais accéder à tous les services de la plateforme étudiante. Bienvenue!",
          actionText: null,
          actionFunction: null,
        },
      ];

      function generateNotifications() {
        const notificationList = document.getElementById("notification-list");
        const template = document.getElementById("notification-template");

        // Vider la liste sauf le template
        while (notificationList.firstChild) {
          if (notificationList.firstChild.id !== "notification-template") {
            notificationList.removeChild(notificationList.firstChild);
          } else {
            break;
          }
        }

        notificationsData.forEach((notif) => {
          const clone = template.cloneNode(true);
          clone.id = "";
          clone.style.display = "block";

          clone.className = `notification-item ${notif.read ? "" : "unread"} ${
            notif.type
          }`;
          clone.setAttribute("data-type", notif.type);
          clone.setAttribute("data-read", notif.read.toString());

          // Remplir les donnees
          clone.querySelector(
            ".notification-icon"
          ).className = `notification-icon ${notif.iconClass}`;
          clone.querySelector(".notification-icon").textContent = notif.icon;
          clone.querySelector(".notification-title-text").textContent =
            notif.title;
          clone.querySelector(".notification-date").textContent = notif.date;
          clone.querySelector(".notification-content").textContent =
            notif.content;

          // Gerer le badge si la notification est non lue
          if (!notif.read) {
            clone.querySelector(".notification-badge").style.display = "block";
          } else {
            clone.querySelector(".notification-badge").style.display = "none";
          }

          const actionButtons = clone.querySelector(".notification-actions");
          actionButtons.innerHTML = "";

          if (!notif.read) {
            const readButton = document.createElement("button");
            readButton.className = "notification-btn";
            readButton.textContent = "Marquer comme lu";
            readButton.onclick = function () {
              markAsRead(this);
            };
            actionButtons.appendChild(readButton);
          } else {
            const deleteButton = document.createElement("button");
            deleteButton.className = "notification-btn";
            deleteButton.textContent = "Supprimer";
            deleteButton.onclick = function () {
              deleteNotification(this);
            };
            actionButtons.appendChild(deleteButton);
          }

          if (notif.actionText) {
            const actionButton = document.createElement("button");
            actionButton.className = "notification-btn primary";
            actionButton.textContent = notif.actionText;
            actionButton.onclick = function () {
              eval(notif.actionFunction);
            };
            actionButtons.appendChild(actionButton);
          }

          notificationList.appendChild(clone);
        });

        // Masquer le template
        template.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // 1. Retrieve token and student data from storage
        authToken =
          sessionStorage.getItem("etudiant_token") ||
          localStorage.getItem("etudiant_token");

        // Load student data from localStorage
        const studentDataJson =
          localStorage.getItem("studentData") ||
          sessionStorage.getItem("studentData");

        if (studentDataJson) {
          try {
            const studentData = JSON.parse(studentDataJson);
            currentUser = studentData;

            // Charger la navbar
            fetch("etudiant-nav.html")
              .then((response) => response.text())
              .then((html) => {
                document.getElementById("navbar-container").innerHTML = html;

                const avatar = document.getElementById("userAvatar");
                const fullName = document.getElementById("userFullName");
                const userId = document.getElementById("userId");

                if (avatar) {
                  const firstInitial = studentData.firstName
                    ? studentData.firstName.charAt(0)
                    : "";
                  const lastInitial = studentData.lastName
                    ? studentData.lastName.charAt(0)
                    : "";
                  avatar.textContent = (
                    firstInitial + lastInitial
                  ).toUpperCase();
                }

                if (fullName)
                  fullName.textContent =
                    `${studentData.firstName || ""} ${
                      studentData.lastName || ""
                    }`.trim() || "Utilisateur";
                if (userId) userId.textContent = studentData.matricule || "N/A";

                document.querySelectorAll(".nav-link").forEach((link) => {
                  link.classList.remove("active");
                  if (link.getAttribute("href") === "notification.html") {
                    link.classList.add("active");
                  }
                });
              });
          } catch (e) {
            console.error("Error parsing stored student data:", e);
          }
        }

        // Générer les notifications
        generateNotifications();
      });

      // Fonction pour filtrer les notifications
      function filterNotifications(type) {
        // Mettre à jour les boutons de filtre
        const filterButtons = document.querySelectorAll(".filter-btn");
        filterButtons.forEach((button) => {
          button.classList.remove("active");
          if (
            button.textContent.toLowerCase().includes(type) ||
            (type === "unread" && button.textContent.includes("Non lues")) ||
            (type === "all" && button.textContent.includes("Toutes"))
          ) {
            button.classList.add("active");
          }
        });

        // Filtrer les notifications
        const notifications = document.querySelectorAll(".notification-item");
        notifications.forEach((notification) => {
          if (notification.id === "notification-template") return;

          if (type === "all") {
            notification.style.display = "block";
          } else if (type === "unread") {
            if (notification.getAttribute("data-read") === "false") {
              notification.style.display = "block";
            } else {
              notification.style.display = "none";
            }
          } else {
            if (notification.getAttribute("data-type") === type) {
              notification.style.display = "block";
            } else {
              notification.style.display = "none";
            }
          }
        });

        // Vérifier s'il y a des notifications affichées
        checkEmptyState();
      }

      // Fonction pour vérifier s'il n'y a aucune notification à afficher
      function checkEmptyState() {
        const notificationList = document.getElementById("notification-list");
        const visibleNotifications = document.querySelectorAll(
          '.notification-item[style="display: block"]'
        );

        // Supprimer l'état vide s'il existe déjà
        const existingEmptyState = document.querySelector(".empty-state");
        if (existingEmptyState) {
          existingEmptyState.remove();
        }

        // Ajouter l'état vide si nécessaire
        if (visibleNotifications.length === 0) {
          const emptyState = document.createElement("div");
          emptyState.className = "empty-state";
          emptyState.innerHTML = `
                <div class="empty-state-icon">📭</div>
                <div class="empty-state-text">Aucune notification à afficher</div>
            `;
          notificationList.appendChild(emptyState);
        }
      }

      // Fonction pour marquer une notification comme lue
      function markAsRead(button) {
        const notification = button.closest(".notification-item");
        notification.classList.remove("unread");
        notification.setAttribute("data-read", "true");

        // Supprimer le badge
        const badge = notification.querySelector(".notification-badge");
        if (badge) {
          badge.style.display = "none";
        }

        // Remplacer le bouton "Marquer comme lu" par "Supprimer"
        button.textContent = "Supprimer";
        button.onclick = function () {
          deleteNotification(this);
        };

        // Mettre à jour le compteur dans le menu
        updateNotificationCounter();
      }

      // Fonction pour supprimer une notification
      function deleteNotification(button) {
        const notification = button.closest(".notification-item");
        notification.style.opacity = "0";
        setTimeout(() => {
          notification.remove();
          checkEmptyState();
        }, 300);

        // Mettre à jour le compteur si nécessaire
        if (notification.classList.contains("unread")) {
          updateNotificationCounter();
        }
      }

      // Fonction pour marquer toutes les notifications comme lues
      function markAllAsRead() {
        const unreadNotifications = document.querySelectorAll(
          ".notification-item.unread"
        );
        unreadNotifications.forEach((notification) => {
          if (notification.id === "notification-template") return;

          notification.classList.remove("unread");
          notification.setAttribute("data-read", "true");

          // Supprimer le badge
          const badge = notification.querySelector(".notification-badge");
          if (badge) {
            badge.style.display = "none";
          }

          // Mettre à jour le bouton
          const readButton = notification.querySelector("button:first-of-type");
          if (readButton) {
            readButton.textContent = "Supprimer";
            readButton.onclick = function () {
              deleteNotification(this);
            };
          }
        });

        // Mettre à jour le compteur
        updateNotificationCounter();
      }

      // Fonction pour supprimer toutes les notifications lues
      function deleteAllRead() {
        const readNotifications = document.querySelectorAll(
          ".notification-item:not(.unread)"
        );
        readNotifications.forEach((notification) => {
          if (notification.id === "notification-template") return;

          notification.style.opacity = "0";
          setTimeout(() => {
            notification.remove();
            checkEmptyState();
          }, 300);
        });
      }

      // Fonction pour mettre à jour le compteur de notifications
      function updateNotificationCounter() {
        const unreadCount = document.querySelectorAll(
          ".notification-item.unread"
        ).length;
        const badge = document.querySelector(".nav-item .badge");

        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = "flex";
          } else {
            badge.style.display = "none";
          }
        }
      }

      // Fonctions pour les actions de notification
      function viewDetails(id) {
        alert(`Redirection vers les détails de la demande ${id}`);
      }

      function viewCalendar(id) {
        alert(`Ouverture du calendrier - Événement ${id}`);
      }

      function viewResults(id) {
        alert(`Consultation des résultats pour ${id}`);
      }

      function viewSchedule() {
        alert("Ouverture de l'emploi du temps");
      }

      function viewDocument(id) {
        alert(`Téléchargement du document ${id}`);
      }

      function addToCalendar(id) {
        alert(`Événement ${id} ajouté au calendrier`);
      }

      // Fonction pour se déconnecter
      function logout() {
        // Clear all specific student-related items
        localStorage.removeItem("studentData");
        localStorage.removeItem("etudiant_token");
        localStorage.removeItem("offlineRequests");
        localStorage.removeItem("lastLogin");
        localStorage.removeItem("userPreferences");

        // Clear all session storage items
        sessionStorage.clear();

        // Redirect to login page
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
