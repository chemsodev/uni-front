<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demandes de Changement de Section - Administration</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sora:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link href="style/admin.css" rel="stylesheet" />
    <link href="style/section-statistics.css" rel="stylesheet" />
    <!-- Add reference to admin auth helper -->    <script src="js/admin-auth.js"></script>
    <script src="js/admin-pages-validation.js"></script>
    <script src="js/admin-mocks.js"></script>
    <script src="js/admin-api-utils.js"></script>
    <script src="js/admin-api-fetchers.js"></script>
    <script src="js/admin-api-loader.js"></script>
    <script src="js/admin-demandes-section.js"></script>
    <script src="js/section-statistics.js"></script>
    <!-- Chart.js for statistics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Added reference to our new script -->
    <style>
      .student-info {
        display: flex;
        align-items: center;
      }

      .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 10px;
      }

      .student-details span {
        display: block;
      }

      .student-name {
        font-weight: 600;
      }

      .student-matricule {
        color: var(--gray-color);
        font-size: 0.85rem;
      }

      .section-badge {
        display: inline-flex;
        align-items: center;
        background-color: #f0f4ff;
        color: #3b82f6;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        gap: 0.25rem;
      }

      .section-badge svg {
        width: 12px;
        height: 12px;
      }

      .section-change-arrow {
        color: var(--gray-color);
        margin: 0 0.5rem;
      }

      .section-change-container {
        display: flex;
        align-items: center;
      }

      .request-details {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        font-size: 0.875rem;
      }

      .request-details h3 {
        margin-bottom: 0.5rem;
        font-size: 1rem;
        color: var(--dark-color);
      }

      .request-details p {
        margin-bottom: 0.5rem;
        color: var(--gray-color);
      }

      .request-details-label {
        font-weight: 600;
        color: var(--dark-color);
      }

      .notes-field {
        min-height: 100px;
        resize: vertical;
      }

      .request-status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .status-pending {
        background-color: #fef3c7;
        color: #d97706;
      }

      .status-approved {
        background-color: #d1fae5;
        color: #059669;
      }

      .status-rejected {
        background-color: #fee2e2;
        color: #dc2626;
      }

      .document-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
        font-size: 0.875rem;
        text-decoration: none;
        margin-top: 0.5rem;
      }

      .document-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar - will be loaded via JavaScript -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">Demandes de Changement de Section</h1>
        </div>

        <div class="content-container">
          <!-- Status Messages -->
          <div
            id="status-message"
            class="status-message"
            style="display: none"
          ></div>

          <!-- Dashboard Cards -->
          <div class="cards-grid">
            <!-- Total Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-card-value" id="total-requests">--</div>
              <div class="stat-card-description">Toutes les demandes</div>
            </div>

            <!-- Pending Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
              </div>
              <div class="stat-card-value" id="pending-requests">--</div>
              <div class="stat-card-description">En attente</div>
            </div>

            <!-- Approved Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
              <div class="stat-card-value" id="approved-requests">--</div>
              <div class="stat-card-description">Approuvées</div>
            </div>

            <!-- Rejected Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </div>
              <div class="stat-card-value" id="rejected-requests">--</div>
              <div class="stat-card-description">Rejetées</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="filters">
            <div class="filter-item">
              <label for="status-filter">Statut</label>
              <select id="status-filter" class="filter-select">
                <option value="all">Tous</option>
                <option value="pending">En attente</option>
                <option value="approved">Approuvée</option>
                <option value="rejected">Rejetée</option>
              </select>
            </div>
            <div class="filter-item">
              <label for="search">Recherche</label>
              <input
                type="text"
                id="search"
                class="filter-input"
                placeholder="Nom, matricule..."
              />
            </div>
          </div>

          <!-- Requests Table -->
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Étudiant</th>
                  <th>Section Actuelle</th>
                  <th>Section Demandée</th>
                  <th>Date de Demande</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requests-table-body">
                <tr>
                  <td colspan="6" class="text-center">
                    Chargement des demandes...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination" id="pagination">
            <!-- Pagination will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Request Details Modal -->
    <div id="request-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 class="modal-title">Détails de la Demande</h2>

        <div class="student-info">
          <div id="student-avatar" class="student-avatar">EA</div>
          <div class="student-details">
            <span id="student-name" class="student-name">Etudiant</span>
            <span id="student-matricule" class="student-matricule"
              >MAT123456</span
            >
          </div>
        </div>

        <div class="details-container" style="margin-top: 1.5rem">
          <div class="detail-row">
            <div class="detail-label">Email:</div>
            <div id="student-email" class="detail-value">
              etudiant@example.com
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Date de Demande:</div>
            <div id="request-date" class="detail-value">01/01/2023</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Statut:</div>
            <div
              id="request-status"
              class="detail-value request-status status-pending"
            >
              En attente
            </div>
          </div>

          <div class="section-change-container" style="margin: 1.5rem 0">
            <div>
              <div class="detail-label">Section Actuelle:</div>
              <div id="current-section" class="section-badge">Section A</div>
            </div>

            <div class="section-change-arrow">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M5 12h14"></path>
                <path d="m12 5 7 7-7 7"></path>
              </svg>
            </div>

            <div>
              <div class="detail-label">Section Demandée:</div>
              <div id="requested-section" class="section-badge">Section B</div>
            </div>
          </div>
        </div>

        <div class="request-details">
          <h3>Justification</h3>
          <p id="request-reason-text">
            La raison de demande sera affichée ici.
          </p>

          <div id="document-container" style="margin-top: 1rem; display: none">
            <h3>Document Justificatif</h3>
            <a
              id="document-link"
              href="#"
              class="document-link"
              target="_blank"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span id="document-name">document.pdf</span>
            </a>
          </div>
        </div>

        <div
          id="admin-response-container"
          class="request-details"
          style="display: none"
        >
          <h3>Réponse Administrative</h3>
          <p id="admin-response-text"></p>
        </div>

        <div
          id="action-buttons"
          class="modal-actions"
          style="margin-top: 1.5rem"
        >
          <textarea
            id="admin-comment"
            class="notes-field"
            placeholder="Ajouter un commentaire (optionnel)"
          ></textarea>

          <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
            <button id="approve-btn" class="btn btn-success">
              Approuver la demande
            </button>
            <button id="reject-btn" class="btn btn-danger">
              Rejeter la demande
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let allRequests = [];
      // Using existing filteredRequests from admin-demandes-section.js
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentRequest = null;
      let authToken =
        sessionStorage.getItem("admin_token") ||
        localStorage.getItem("admin_token");
      let adminRole =
        sessionStorage.getItem("admin_role") ||
        localStorage.getItem("admin_role");

      // DOM Elements
      const statusMessage = document.getElementById("status-message");
      const requestsTableBody = document.getElementById("requests-table-body");
      const paginationElement = document.getElementById("pagination");
      const statusFilter = document.getElementById("status-filter");
      // Stats elements
      const totalRequestsEl = document.getElementById("total-requests");
      const pendingRequestsEl = document.getElementById("pending-requests");
      const approvedRequestsEl = document.getElementById("approved-requests");
      const rejectedRequestsEl = document.getElementById("rejected-requests");

      // Modal elements
      const requestModal = document.getElementById("request-modal");
      const closeModalBtn = document.querySelector(".close-modal");
      const studentAvatar = document.getElementById("student-avatar");
      const studentName = document.getElementById("student-name");
      const studentMatricule = document.getElementById("student-matricule");
      const studentEmail = document.getElementById("student-email");
      const requestDate = document.getElementById("request-date");
      const requestStatus = document.getElementById("request-status");
      const currentSection = document.getElementById("current-section");
      const requestedSection = document.getElementById("requested-section");
      const requestReasonText = document.getElementById("request-reason-text");
      const documentContainer = document.getElementById("document-container");

      // Event listeners
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Verify admin token first
          await verifyAdminToken();

          // Load sidebar and data
          await loadSidebar();
          await loadRequests();
          setupEventListeners();
          updateStats(); // Initial stats calculation
        } catch (error) {
          console.error("Error initializing page:", error);
          showMessage("Erreur lors du chargement de la page", "error");
        }
      });
      async function loadRequests() {
        if (!requestsTableBody) {
          console.error("requestsTableBody element not found.");
          if (statusMessage)
            statusMessage.textContent = "Erreur: Table non trouvée.";
          return;
        }
        requestsTableBody.innerHTML =
          '<tr><td colspan="6" class="loading">Chargement des demandes...</td></tr>';
        try {          // Use the fetchSectionChangeRequests from admin-api-fetchers.js
          const data = await fetchSectionChangeRequests();
          // Make sure to extract the requests array properly based on API response
          allRequests = Array.isArray(data.requests) ? data.requests :
                      (Array.isArray(data) ? data : []);
          // Create a copy for filtered requests
          filteredRequests = [...allRequests];
          if (allRequests.length === 0) {
            requestsTableBody.innerHTML =
              '<tr><td colspan="6" class="no-data">Aucune demande de changement de section trouvée.</td></tr>';
          } else {
            renderTable();
          }
          updateStats();
        } catch (error) {
          console.error("Error loading requests:", error);
          requestsTableBody.innerHTML = `<tr><td colspan="6" class="status-message error">Erreur de chargement des demandes: ${
            error.message || "Veuillez réessayer."
          }</td></tr>`;
          if (statusMessage)
            showMessage(`Erreur de chargement: ${error.message}`, "error");
        }
      }

      function setupEventListeners() {
        if (statusFilter) {
          statusFilter.addEventListener("change", () => {
            filterAndRender();
          });
        }
        if (closeModalBtn) {
          closeModalBtn.addEventListener("click", closeModal);
        }
        window.addEventListener("click", (event) => {
          if (event.target === requestModal) {
            closeModal();
          }
        });
        // Add other listeners like search if a search input is added
      }

      function filterAndRender() {
        const status = statusFilter ? statusFilter.value : "all";
        // Add search filter logic if a search input exists
        // const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

        filteredRequests = allRequests.filter((request) => {
          const matchesStatus = status === "all" || request.status === status;
          // const matchesSearch = searchTerm === "" ||
          //                       request.student?.name?.toLowerCase().includes(searchTerm) ||
          //                       request.student?.matricule?.toLowerCase().includes(searchTerm) ||
          //                       request.currentSection?.name?.toLowerCase().includes(searchTerm) ||
          //                       request.requestedSection?.name?.toLowerCase().includes(searchTerm);
          // return matchesStatus && matchesSearch;
          return matchesStatus;
        });
        currentPage = 1;
        renderTable();
        updateStats();
      }

      function renderTable() {
        if (!requestsTableBody) return;
        requestsTableBody.innerHTML = ""; // Clear previous rows

        if (filteredRequests.length === 0) {
          requestsTableBody.innerHTML =
            '<tr><td colspan="6" class="no-data">Aucune demande ne correspond aux filtres.</td></tr>';
          updatePagination();
          return;
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

        paginatedRequests.forEach((request) => {
          const row = document.createElement("tr");
          // Adjust according to the actual data structure from your backend
          row.innerHTML = `
            <td>
              <div class="student-info">
                <img src="${
                  request.student?.avatar || "placeholder_avatar.png"
                }" alt="Avatar" class="student-avatar">
                <div class="student-details">
                  <span class="student-name">${
                    request.student?.name || "N/A"
                  }</span>
                  <span class="student-matricule">Mat: ${
                    request.student?.matricule || "N/A"
                  }</span>
                </div>
              </div>
            </td>
            <td><span class="section-badge">${
              request.currentSection?.name || "N/A"
            }</span></td>
            <td><span class="section-badge">${
              request.requestedSection?.name || "N/A"
            }</span></td>
            <td>${new Date(request.dateSubmitted).toLocaleDateString()}</td>
            <td><span class="request-status status-${
              request.status?.toLowerCase() || "pending"
            }">${request.status || "En attente"}</span></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="openModal('${
                request.id
              }')">Détails</button>
              <!-- Add approve/reject buttons if direct actions are needed here -->
            </td>
          `;
          requestsTableBody.appendChild(row);
        });
        updatePagination();
      }

      function updatePagination() {
        if (!paginationElement) return;
        paginationElement.innerHTML = "";
        const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const button = document.createElement("button");
          button.textContent = i;
          button.classList.add("pagination-btn");
          if (i === currentPage) {
            button.classList.add("active");
          }
          button.addEventListener("click", () => {
            currentPage = i;
            renderTable();
          });
          paginationElement.appendChild(button);
        }
      }

      function updateStats() {
        if (totalRequestsEl) totalRequestsEl.textContent = allRequests.length;
        if (pendingRequestsEl)
          pendingRequestsEl.textContent = allRequests.filter(
            (r) => r.status === "pending"
          ).length;
        if (approvedRequestsEl)
          approvedRequestsEl.textContent = allRequests.filter(
            (r) => r.status === "approved"
          ).length;
        if (rejectedRequestsEl)
          rejectedRequestsEl.textContent = allRequests.filter(
            (r) => r.status === "rejected"
          ).length;
        // Potentially update charts if they are present and configured
      }

      async function openModal(requestId) {
        currentRequest = allRequests.find((r) => r.id === requestId);
        if (!currentRequest || !requestModal) return;

        // Populate modal fields - adjust selectors and properties based on your modal HTML and data
        if (studentAvatar)
          studentAvatar.src =
            currentRequest.student?.avatar || "placeholder_avatar.png";
        if (studentName)
          studentName.textContent = currentRequest.student?.name || "N/A";
        if (studentMatricule)
          studentMatricule.textContent = `Matricule: ${
            currentRequest.student?.matricule || "N/A"
          }`;
        if (studentEmail)
          studentEmail.textContent = `Email: ${
            currentRequest.student?.email || "N/A"
          }`;
        if (requestDate)
          requestDate.textContent = `Soumis le: ${new Date(
            currentRequest.dateSubmitted
          ).toLocaleString()}`;
        if (requestStatus) {
          requestStatus.textContent = currentRequest.status || "En attente";
          requestStatus.className = `request-status status-${
            currentRequest.status?.toLowerCase() || "pending"
          }`;
        }
        if (currentSection)
          currentSection.textContent =
            currentRequest.currentSection?.name || "N/A";
        if (requestedSection)
          requestedSection.textContent =
            currentRequest.requestedSection?.name || "N/A";
        if (requestReasonText)
          requestReasonText.textContent =
            currentRequest.reason || "Aucune raison fournie.";

        if (documentContainer) {
          documentContainer.innerHTML = ""; // Clear previous documents
          if (currentRequest.documents && currentRequest.documents.length > 0) {
            currentRequest.documents.forEach((doc) => {
              const docLink = document.createElement("a");
              docLink.href = doc.url; // Assuming doc object has url and name
              docLink.textContent = doc.name || "Document justificatif";
              docLink.className = "document-link";
              docLink.target = "_blank";
              documentContainer.appendChild(docLink);
            });
          } else {
            documentContainer.innerHTML =
              "<p>Aucun document justificatif fourni.</p>";
          }
        }

        // Add logic for approve/reject buttons within the modal if they exist
        // e.g., const approveBtn = document.getElementById('approve-request-btn');
        // approveBtn.onclick = () => handleUpdateRequest(currentRequest.id, 'approved');

        requestModal.style.display = "block";
      }

      function closeModal() {
        if (requestModal) requestModal.style.display = "none";
        currentRequest = null;
      }      // Example: Function to handle updating request status (called from modal buttons)
      async function handleUpdateRequest(
        requestId,
        newStatus,
        adminNotes = ""
      ) {
        if (!authToken) {
          showMessage("Authentification requise.", "error");
          return;
        }
        try {
          // Assuming updateSectionChangeRequestStatus is defined in admin-api-utils.js or similar
          const response = await updateSectionChangeRequestStatus(
            requestId,
            newStatus,
            adminNotes,
            authToken
          );          if (response && response.success) {
            showMessage("Statut de la demande mis à jour avec succès.", "success");
            await loadRequests(); // Reload the list
          } else {
            showMessage(response?.message || "Échec de la mise à jour du statut.", "error");
          }
        } catch (error) {
          console.error("Error updating request:", error);
          showMessage(`Erreur: ${error.message || "Opération échouée"}`, "error");
        }
      }
