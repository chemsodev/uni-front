<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Groupe et Section - Profil Étudiant</title>
    <link href="style/group-section.css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div id="navbar-container"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">Groupe et Section</h1>
          <div class="header-actions">
            <button id="refresh-btn" class="btn-icon" title="Actualiser">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 3a5 5 0 0 0-5 5h1a1 1 0 0 1 1 1 1 1 0 0 1-1 1H3a6 6 0 1 1 6 6v1a1 1 0 0 1-1 1 1 1 0 0 1-1-1v-1a5 5 0 0 0 5-5h1a1 1 0 0 1 1 1 1 1 0 0 1-1 1h-1a6 6 0 0 1-6 6v1a1 1 0 0 1-1 1 1 1 0 0 1-1-1v-1a5 5 0 0 0-5-5H1a1 1 0 0 1-1-1 1 1 0 0 1 1-1h1a6 6 0 0 1 6-6V1a1 1 0 0 1 1-1 1 1 0 0 1 1 1v1a5 5 0 0 0 5 5h1a1 1 0 0 1 1 1 1 1 0 0 1-1 1H8z"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="group-container">
          <!-- Information sur les affectations -->
          <div class="card">
            <h2 class="card-title">
              <span class="card-title-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"
                  />
                </svg>
              </span>
              Mes affectations
            </h2>
            <div class="info-grid" id="affectations-grid">
              <!-- Les données seront chargées dynamiquement -->
            </div>
          </div>

          <!-- Upload Emploi du temps -->
          <div class="card">
            <h2 class="card-title">
              <span class="card-title-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"
                  />
                </svg>
              </span>
              Emploi du temps
            </h2>

            <div class="file-upload-container">
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".jpg,.jpeg,.png,.pdf,.doc,.docx"
              />
              <div class="upload-area" id="uploadArea">
                <svg
                  class="upload-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="upload-text">
                  Glissez et déposez votre emploi du temps
                </div>
                <div class="upload-hint">
                  Formats acceptés: JPG, PNG, PDF, DOCX (max. 10 Mo)
                </div>
                <button class="upload-btn" id="selectFileBtn">
                  Sélectionner un fichier
                </button>
              </div>

              <div
                class="preview-container"
                id="previewContainer"
                style="display: none"
              >
                <div class="preview-header">
                  <div class="preview-title">Aperçu du fichier</div>
                  <div class="preview-actions">
                    <button class="preview-btn" id="downloadBtn">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"
                        />
                        <path
                          d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"
                        />
                      </svg>
                      Télécharger
                    </button>
                    <button class="preview-btn preview-delete" id="deleteBtn">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"
                        />
                        <path
                          fill-rule="evenodd"
                          d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"
                        />
                      </svg>
                      Supprimer
                    </button>
                  </div>
                </div>
                <div class="preview-content" id="previewContent"></div>
                <div class="file-info">
                  <span id="fileName"></span>
                  <span id="fileSize"></span>
                  <span id="uploadDate"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Informations sur les responsables -->
          <div class="card">
            <h2 class="card-title">
              <span class="card-title-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                  />
                </svg>
              </span>
              Responsables pédagogiques
            </h2>
            <div class="info-grid" id="responsables-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const API_BASE_URL = "http://localhost:3000/api";
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const ACCEPTED_FILE_TYPES = [
        "image/jpeg",
        "image/png",
        "application/pdf",
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      ];

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Charger la navbar
          await loadNavbar();

          // Charger les données étudiant
          const studentData = await loadStudentData();

          // Mettre à jour les infos utilisateur dans la navbar
          updateNavbarUserInfo(studentData);

          // Initialiser les composants
          initFileUpload();
          setupEventListeners();

          // Charger les données des groupes et responsables
          await loadGroupData(studentData);
          await loadTimetable();
        } catch (error) {
          console.error("Erreur d'initialisation:", error);
          showToast("Erreur lors du chargement des données", "error");
        }
      });

      async function loadNavbar() {
        try {
          const response = await fetch("etudiant-nav.html");
          if (!response.ok)
            throw new Error("Erreur de chargement de la navbar");

          const html = await response.text();
          document.getElementById("navbar-container").innerHTML = html;

          // Activer le lien actif
          document.querySelectorAll(".nav-link").forEach((link) => {
            link.classList.remove("active");
            if (link.getAttribute("href") === "group-section.html") {
              link.classList.add("active");
            }
          });
        } catch (error) {
          console.error("Erreur:", error);
          throw error;
        }
      }

      function updateNavbarUserInfo(studentData) {
        if (!studentData) {
          console.warn("Aucune donnée étudiant trouvée dans le localStorage.");
          return;
        }

        const avatar = document.getElementById("userAvatar");
        const fullName = document.getElementById("userFullName");
        const userId = document.getElementById("userId");

        if (avatar) {
          if (studentData.firstName && studentData.lastName) {
            avatar.textContent = (
              studentData.firstName.charAt(0) + studentData.lastName.charAt(0)
            ).toUpperCase();
          } else if (studentData.prenom && studentData.nom) {
            avatar.textContent = (
              studentData.prenom.charAt(0) + studentData.nom.charAt(0)
            ).toUpperCase();
          } else {
            avatar.textContent = "ET";
          }
        }

        if (fullName) {
          if (studentData.firstName && studentData.lastName) {
            fullName.textContent = `${studentData.firstName} ${studentData.lastName}`;
          } else if (studentData.prenom && studentData.nom) {
            fullName.textContent = `${studentData.prenom} ${studentData.nom}`;
          } else {
            fullName.textContent = "Étudiant";
          }
        }

        if (userId) {
          if (studentData.matricule) {
            userId.textContent = `Matricule: ${studentData.matricule}`;
          } else if (studentData.id) {
            userId.textContent = `ID: ${studentData.id}`;
          } else {
            userId.textContent = "Utilisateur";
          }
        }
      }

      async function loadStudentData() {
        // Try to get data from localStorage first
        let studentData = null;
        try {
          studentData = JSON.parse(localStorage.getItem("studentData"));
        } catch (e) {
          console.error("Error parsing stored student data:", e);
        }

        if (!studentData) {
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error("Vous n'êtes pas connecté");
            }

            // Extract user ID from JWT token
            let userId = null;
            try {
              const tokenPayload = JSON.parse(atob(token.split(".")[1]));
              userId = tokenPayload.userId;
            } catch (e) {
              console.error("Could not extract user ID from token:", e);
              throw new Error("Token invalide");
            }

            // Fetch student data using the token
            const response = await fetch(
              `${API_BASE_URL}/etudiants/${userId}`,
              {
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                signal: AbortSignal.timeout(10000),
              }
            );

            if (!response.ok) {
              throw new Error("Erreur de chargement des données étudiant");
            }

            studentData = await response.json();
            localStorage.setItem("studentData", JSON.stringify(studentData));
          } catch (error) {
            console.error("Erreur:", error);

            // If error is timeout or network related, show offline message
            if (
              error.name === "AbortError" ||
              error.message.includes("Failed to fetch")
            ) {
              showToast(
                "Connexion au serveur impossible. Mode hors ligne activé.",
                "warning"
              );
            } else {
              throw error;
            }
          }
        }
        return studentData || {};
      }

      async function loadGroupData(studentData) {
        try {
          if (!studentData) {
            throw new Error("Données étudiant non disponibles");
          }

          // Get section information
          const sectionDetails = await fetchSectionDetails(studentData);

          // Mettre à jour les affectations
          const affectationsGrid = document.getElementById("affectations-grid");
          affectationsGrid.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Filière</div>
                        <div class="info-value">${
                          sectionDetails.filiere || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Section</div>
                        <div class="info-value">${
                          sectionDetails.sectionName || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Groupe TD</div>
                        <div class="info-value">${
                          sectionDetails.tdGroup || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Groupe TP</div>
                        <div class="info-value">${
                          sectionDetails.tpGroup || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Année académique</div>
                        <div class="info-value">${
                          sectionDetails.academicYear || "2023-2024"
                        }</div>
                    </div>
                `;

          // Mettre à jour les responsables
          const responsableDetails = await fetchResponsables(
            sectionDetails.sectionId
          );
          const responsablesGrid = document.getElementById("responsables-grid");
          responsablesGrid.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Responsable de filière</div>
                        <div class="info-value">${
                          responsableDetails.filiere || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Responsable de section</div>
                        <div class="info-value">${
                          responsableDetails.section || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Responsable TD</div>
                        <div class="info-value">${
                          responsableDetails.td || "Non spécifié"
                        }</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Responsable TP</div>
                        <div class="info-value">${
                          responsableDetails.tp || "Non spécifié"
                        }</div>
                    </div>
                `;
        } catch (error) {
          console.error("Erreur:", error);

          // Fallback data if API call fails
          const fallbackSection = {
            filiere: studentData.filiere || "Informatique",
            sectionName: studentData.section || "Section A",
            tdGroup: studentData.groupeTD || "TD 1",
            tpGroup: studentData.groupeTP || "TP 2",
            academicYear: "2023-2024",
          };

          const fallbackResponsables = {
            filiere: "Dr. Mohammed BENSAAD",
            section: "Dr. RAHMANI AHMED",
            td: "Dr. Karim MEZIANI",
            tp: "Dr. Samira TALEB",
          };

          // Update UI with fallback data
          const affectationsGrid = document.getElementById("affectations-grid");
          affectationsGrid.innerHTML = `
            <div class="info-item">
                <div class="info-label">Filière</div>
                <div class="info-value">${fallbackSection.filiere}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Section</div>
                <div class="info-value">${fallbackSection.sectionName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Groupe TD</div>
                <div class="info-value">${fallbackSection.tdGroup}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Groupe TP</div>
                <div class="info-value">${fallbackSection.tpGroup}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Année académique</div>
                <div class="info-value">${fallbackSection.academicYear}</div>
            </div>
          `;

          const responsablesGrid = document.getElementById("responsables-grid");
          responsablesGrid.innerHTML = `
            <div class="info-item">
                <div class="info-label">Responsable de filière</div>
                <div class="info-value">${fallbackResponsables.filiere}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Responsable de section</div>
                <div class="info-value">${fallbackResponsables.section}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Responsable TD</div>
                <div class="info-value">${fallbackResponsables.td}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Responsable TP</div>
                <div class="info-value">${fallbackResponsables.tp}</div>
            </div>
          `;

          showToast(
            "Mode hors ligne: certaines informations peuvent ne pas être à jour",
            "warning"
          );
        }
      }

      async function fetchSectionDetails(studentData) {
        // Extract section ID from student data if available
        const sectionId = studentData.section?.id || studentData.sectionId;

        if (!sectionId) {
          return {
            filiere: studentData.filiere || "Informatique",
            sectionName: studentData.section || "Section A",
            tdGroup: studentData.groupeTD || "TD 1",
            tpGroup: studentData.groupeTP || "TP 2",
            academicYear: "2023-2024",
          };
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/sections/${sectionId}`,
            {
              headers: getAuthHeaders(),
              signal: AbortSignal.timeout(5000),
            }
          );

          if (!response.ok) {
            throw new Error("Erreur de chargement des données de section");
          }

          const sectionData = await response.json();
          return {
            sectionId: sectionData.id,
            filiere: sectionData.filiere?.nom || "Informatique",
            sectionName: sectionData.nom || "Section A",
            tdGroup: studentData.tdGroup || "TD 1",
            tpGroup: studentData.tpGroup || "TP 2",
            academicYear: sectionData.anneeAcademique || "2023-2024",
          };
        } catch (error) {
          console.error(
            "Erreur lors de la récupération des détails de section:",
            error
          );
          // Return default values if API call fails
          return {
            filiere: studentData.filiere || "Informatique",
            sectionName: studentData.section || "Section A",
            tdGroup: studentData.groupeTD || "TD 1",
            tpGroup: studentData.groupeTP || "TP 2",
            academicYear: "2023-2024",
          };
        }
      }

      async function fetchResponsables(sectionId) {
        if (!sectionId) {
          return {
            filiere: "Dr. Mohammed BENSAAD",
            section: "Dr. RAHMANI AHMED",
            td: "Dr. Karim MEZIANI",
            tp: "Dr. Samira TALEB",
          };
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/sections/${sectionId}/responsables`,
            {
              headers: getAuthHeaders(),
              signal: AbortSignal.timeout(5000),
            }
          );

          if (!response.ok) {
            throw new Error("Erreur de chargement des responsables");
          }

          const responsablesData = await response.json();
          return {
            filiere: responsablesData.filiere?.nom || "Dr. Mohammed BENSAAD",
            section: responsablesData.section?.nom || "Dr. RAHMANI AHMED",
            td: responsablesData.td?.nom || "Dr. Karim MEZIANI",
            tp: responsablesData.tp?.nom || "Dr. Samira TALEB",
          };
        } catch (error) {
          console.error(
            "Erreur lors de la récupération des responsables:",
            error
          );
          // Return default values if API call fails
          return {
            filiere: "Dr. Mohammed BENSAAD",
            section: "Dr. RAHMANI AHMED",
            td: "Dr. Karim MEZIANI",
            tp: "Dr. Samira TALEB",
          };
        }
      }

      async function loadTimetable() {
        try {
          const response = await fetch(`${API_BASE_URL}/etudiants/timetable`, {
            headers: getAuthHeaders(),
            signal: AbortSignal.timeout(5000),
          });

          if (response.ok) {
            const timetable = await response.json();
            if (timetable.fileUrl) {
              displayUploadedFile(timetable);
            }
          } else {
            // Check if there's a cached timetable in localStorage
            const cachedTimetable = localStorage.getItem("studentTimetable");
            if (cachedTimetable) {
              displayUploadedFile(JSON.parse(cachedTimetable));
            }
          }
        } catch (error) {
          console.error("Erreur:", error);
          // Check if there's a cached timetable in localStorage
          const cachedTimetable = localStorage.getItem("studentTimetable");
          if (cachedTimetable) {
            displayUploadedFile(JSON.parse(cachedTimetable));
          }
        }
      }

      function initFileUpload() {
        const fileInput = document.getElementById("fileInput");
        const uploadArea = document.getElementById("uploadArea");
        const selectFileBtn = document.getElementById("selectFileBtn");

        // Gestion du clic
        uploadArea.addEventListener("click", () => fileInput.click());
        selectFileBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          fileInput.click();
        });

        // Gestion du drag and drop
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");

          if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            handleFileUpload(fileInput.files[0]);
          }
        });

        // Gestion de la sélection de fichier
        fileInput.addEventListener("change", () => {
          if (fileInput.files.length) {
            handleFileUpload(fileInput.files[0]);
          }
        });

        // Gestion des boutons
        document
          .getElementById("downloadBtn")
          .addEventListener("click", downloadFile);
        document
          .getElementById("deleteBtn")
          .addEventListener("click", deleteFile);
      }

      async function handleFileUpload(file) {
        // Validation du fichier
        if (!ACCEPTED_FILE_TYPES.includes(file.type)) {
          showToast("Type de fichier non supporté", "error");
          return;
        }

        if (file.size > MAX_FILE_SIZE) {
          showToast("Fichier trop volumineux (max 10 Mo)", "error");
          return;
        }

        try {
          // Afficher le loader
          document.getElementById("previewContainer").style.display = "block";
          document.getElementById("previewContent").innerHTML =
            '<div class="loader">Chargement...</div>';

          // Envoyer le fichier au serveur
          const formData = new FormData();
          formData.append("timetable", file);

          const response = await fetch(`${API_BASE_URL}/etudiants/timetable`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${getAuthToken()}`,
            },
            body: formData,
          });

          if (!response.ok) {
            throw new Error("Erreur lors de l'upload");
          }

          const result = await response.json();

          // Cache the timetable in localStorage
          localStorage.setItem("studentTimetable", JSON.stringify(result));

          displayUploadedFile(result);
          showToast("Emploi du temps mis à jour avec succès", "success");
        } catch (error) {
          console.error("Erreur:", error);
          showToast("Erreur lors de l'envoi du fichier", "error");
          document.getElementById("previewContainer").style.display = "none";

          // For demo purposes, create a local preview instead
          if (!navigator.onLine || error.name === "AbortError") {
            const mockTimetable = {
              fileName: file.name,
              fileSize: file.size,
              fileType: file.type,
              uploadDate: new Date().toISOString(),
              fileUrl: URL.createObjectURL(file),
            };

            localStorage.setItem(
              "studentTimetable",
              JSON.stringify(mockTimetable)
            );
            displayUploadedFile(mockTimetable);
            showToast(
              "Mode hors ligne: Emploi du temps enregistré localement",
              "warning"
            );
          }
        }
      }

      function displayUploadedFile(fileInfo) {
        const previewContent = document.getElementById("previewContent");
        const previewContainer = document.getElementById("previewContainer");
        const fileName = document.getElementById("fileName");
        const fileSize = document.getElementById("fileSize");
        const uploadDate = document.getElementById("uploadDate");

        // Afficher les infos du fichier
        fileName.textContent = fileInfo.fileName;
        fileSize.textContent = formatFileSize(fileInfo.fileSize);
        uploadDate.textContent = new Date(
          fileInfo.uploadDate
        ).toLocaleDateString();

        // Afficher l'aperçu selon le type de fichier
        if (fileInfo.fileType.startsWith("image/")) {
          previewContent.innerHTML = `<img src="${fileInfo.fileUrl}" alt="Aperçu emploi du temps" class="preview-img">`;
        } else if (fileInfo.fileType === "application/pdf") {
          previewContent.innerHTML = `
                    <embed src="${fileInfo.fileUrl}#toolbar=0&navpanes=0" type="application/pdf" class="pdf-embed">
                    <div class="pdf-alternative">
                        <a href="${fileInfo.fileUrl}" target="_blank">Ouvrir dans un nouvel onglet</a>
                    </div>
                `;
        } else {
          previewContent.innerHTML = `
                    <div class="file-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 0h5.5v1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h1V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2z"/>
                            <path d="M9.5 3V0L14 4.5h-3A1.5 1.5 0 0 1 9.5 3z"/>
                        </svg>
                    </div>
                    <div class="file-alternative">
                        <a href="${fileInfo.fileUrl}" target="_blank">Télécharger le fichier</a>
                    </div>
                `;
        }

        // Sauvegarder l'URL pour le téléchargement
        previewContainer.dataset.fileUrl = fileInfo.fileUrl;
        previewContainer.style.display = "block";
      }

      function downloadFile() {
        const fileUrl =
          document.getElementById("previewContainer").dataset.fileUrl;
        if (fileUrl) {
          const a = document.createElement("a");
          a.href = fileUrl;
          a.download = document.getElementById("fileName").textContent;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      }

      async function deleteFile() {
        try {
          const response = await fetch(`${API_BASE_URL}/etudiants/timetable`, {
            method: "DELETE",
            headers: getAuthHeaders(),
          });

          // Remove from localStorage even if API fails
          localStorage.removeItem("studentTimetable");

          if (!response.ok) {
            throw new Error("Erreur lors de la suppression");
          }

          document.getElementById("previewContainer").style.display = "none";
          document.getElementById("fileInput").value = "";
          showToast("Emploi du temps supprimé", "success");
        } catch (error) {
          console.error("Erreur:", error);
          // Even if API fails, we remove the local preview
          document.getElementById("previewContainer").style.display = "none";
          document.getElementById("fileInput").value = "";
          showToast("Emploi du temps supprimé localement", "warning");
        }
      }

      function setupEventListeners() {
        // Bouton d'actualisation
        document
          .getElementById("refresh-btn")
          .addEventListener("click", async () => {
            try {
              // Clear cached data to force fresh fetch
              const studentData = await loadStudentData();
              await loadGroupData(studentData);
              await loadTimetable();
              showToast("Données actualisées", "success");
            } catch (error) {
              console.error("Erreur:", error);
              showToast("Erreur lors de l'actualisation", "error");
            }
          });
      }

      function getAuthHeaders(includeJson = true) {
        const token = getAuthToken();
        const headers = {
          Authorization: `Bearer ${token}`,
        };
        if (includeJson) {
          headers["Content-Type"] = "application/json";
        }
        return headers;
      }

      function getAuthToken() {
        return (
          localStorage.getItem("etudiant_token") ||
          sessionStorage.getItem("etudiant_token")
        );
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    </script>
  </body>
</html>
