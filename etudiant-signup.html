<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Inscription Espace Étudiant</title>
    <link href="style/etudiant-signup.css" rel="stylesheet">
   
</head>
<body>
    <div class="registration-container">
        <h2 class="registration-title">Inscription Étudiant</h2>
        
        <form id="signupForm">
            <div class="section">
                <h3 class="section-title">Informations Personnelles</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="nom">Nom</label>
                        <input type="text" id="nom" class="form-input" placeholder="Votre nom" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="prenom">Prénom</label>
                        <input type="text" id="prenom" class="form-input" placeholder="Votre prénom" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Sexe</label>
                        <div class="radio-group">
                            <input type="radio" id="homme" name="sexe" value="homme" required>
                            <label for="homme">Homme</label>
                            <input type="radio" id="femme" name="sexe" value="femme" required>
                            <label for="femme">Femme</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="date-naissance">Date de Naissance</label>
                        <div class="date-select-group">
                            <select id="jour" name="jour" class="date-select" required>
                                <option value="">Jour</option>
                                <script>
                                    for(let i = 1; i <= 31; i++) {
                                        document.write(`<option value="${i}">${i}</option>`);
                                    }
                                </script>
                            </select>
                            <select id="mois" name="mois" class="date-select" required>
                                <option value="">Mois</option>
                                <option value="1">Janvier</option>
                                <option value="2">Février</option>
                                <option value="3">Mars</option>
                                <option value="4">Avril</option>
                                <option value="5">Mai</option>
                                <option value="6">Juin</option>
                                <option value="7">Juillet</option>
                                <option value="8">Août</option>
                                <option value="9">Septembre</option>
                                <option value="10">Octobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">Décembre</option>
                            </select>
                            <select id="annee" name="annee" class="date-select" required>
                                <option value="">Année</option>
                                <script>
                                    const currentYear = new Date().getFullYear();
                                    for(let i = currentYear - 80; i <= currentYear - 16; i++) {
                                        document.write(`<option value="${i}">${i}</option>`);
                                    }
                                </script>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="nationalite">Nationalité</label>
                    <input type="text" id="nationalite" class="form-input" placeholder="Votre nationalité" required>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">Informations Académiques</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="matricule">Matricule</label>
                        <input type="text" id="matricule" class="form-input" placeholder="20XXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="departement">Département</label>
                        <input type="text" id="departement" class="form-input" placeholder="Votre département" required>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">Coordonnées et Connexion</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="email">Email Étudiant</label>
                        <input type="email" id="email" class="form-input" placeholder="prenom.nom@etu.usthb.dz" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="telephone">Téléphone</label>
                        <input type="tel" id="telephone" class="form-input" placeholder="+ 213 X XX XX XX XX" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="password">Mot de Passe</label>
                        <input type="password" id="password" class="form-input" placeholder="••••••••" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirm-password">Confirmer</label>
                        <input type="password" id="confirm-password" class="form-input" placeholder="••••••••" required>
                    </div>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="handicap" name="handicap">
                <label for="handicap">Étudiant en situation de handicap</label>
            </div>

            <div id="error-message" class="error-message" style="display: none; color: red; margin: 10px 0;"></div>
            <div id="success-message" class="success-message" style="display: none; color: green; margin: 10px 0;"></div>

            <button type="button" id="submit-btn" class="registration-button">S'inscrire</button>
        </form>

        <a href="index.html" class="back-button">Retour à la page de sélection</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const submitBtn = document.getElementById('submit-btn');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            
            submitBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                // Reset messages
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                
                // Validate form
                if (!validateForm()) {
                    return;
                }
                
                // Set loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Inscription en cours...';
                
                try {
                    // Create date string
                    const jour = document.getElementById('jour').value.padStart(2, '0');
                    const mois = document.getElementById('mois').value.padStart(2, '0');
                    const annee = document.getElementById('annee').value;
                    const dateNaissance = `${annee}-${mois}-${jour}`;
                    
                    // Prepare data for API
                    const formData = {
                        firstName: document.getElementById('prenom').value,
                        lastName: document.getElementById('nom').value,
                        gender: document.querySelector('input[name="sexe"]:checked').value,
                        birthDate: dateNaissance,
                        nationality: document.getElementById('nationalite').value,
                        matricule: document.getElementById('matricule').value,
                        department: document.getElementById('departement').value,
                        email: document.getElementById('email').value,
                        phoneNumber: document.getElementById('telephone').value,
                        password: document.getElementById('password').value,
                        hasDisability: document.getElementById('handicap').checked
                    };
                    
                    // Send to API with timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    try {
                        const response = await fetch('http://localhost:3000/api/etudiants/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(formData),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            // Try to parse error message
                            try {
                                const error = await response.json();
                                throw new Error(error.message || 'Erreur lors de l\'inscription');
                            } catch (e) {
                                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                            }
                        }
                        
                        // Show success message
                        successMessage.textContent = 'Inscription réussie! Redirection vers la page de connexion...';
                        successMessage.style.display = 'block';
                        
                        // Redirect to login page after 2 seconds
                        setTimeout(() => {
                            window.location.href = 'etudiant-login.html';
                        }, 2000);
                    } catch (fetchError) {
                        if (fetchError.name === 'AbortError') {
                            throw new Error('La connexion au serveur a pris trop de temps. Veuillez réessayer plus tard.');
                        } else {
                            throw fetchError;
                        }
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    
                    // Handle different types of errors with specific messages
                    if (error.message.includes('Failed to fetch') || 
                        error.message.includes('NetworkError') ||
                        error.message.includes('trop de temps')) {
                        
                        // Server connection issues
                        errorMessage.textContent = 'Impossible de se connecter au serveur. Veuillez vérifier votre connexion internet ou réessayer plus tard.';
                        
                        // Show offline registration options
                        const offlineNotice = document.createElement('div');
                        offlineNotice.className = 'offline-notice';
                        offlineNotice.style.marginTop = '15px';
                        offlineNotice.style.padding = '10px';
                        offlineNotice.style.backgroundColor = '#fff3cd';
                        offlineNotice.style.color = '#856404';
                        offlineNotice.style.borderRadius = '4px';
                        offlineNotice.style.border = '1px solid #ffeeba';
                        
                        // Add more helpful information
                        offlineNotice.innerHTML = `
                            <p><strong>Le serveur est actuellement indisponible.</strong></p>
                            <p>Vous pouvez essayer les options suivantes :</p>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Réessayer l'inscription plus tard</li>
                                <li>Contacter le service informatique au <strong>+213 XX XX XX XX</strong></li>
                                <li>Envoyer un email à <a href="mailto:support@universite.edu">support@universite.edu</a></li>
                                <li>Vous rendre au bureau des inscriptions (Bâtiment administratif, 2ème étage)</li>
                            </ul>
                            <button id="retry-btn" style="margin-top: 10px; padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Réessayer la connexion</button>
                        `;
                        
                        // Insert after error message
                        const existingNotice = document.querySelector('.offline-notice');
                        if (!existingNotice) {
                            errorMessage.parentNode.insertBefore(offlineNotice, errorMessage.nextSibling);
                            
                            // Add retry button functionality
                            document.getElementById('retry-btn').addEventListener('click', function() {
                                // Remove the notice
                                offlineNotice.remove();
                                // Simulate form submission
                                submitBtn.click();
                            });
                        }
                    } else if (error.message.includes('matricule') || error.message.includes('Matricule')) {
                        // Matricule already exists
                        errorMessage.textContent = 'Ce matricule est déjà enregistré. Veuillez utiliser un autre matricule ou contacter l\'administration.';
                    } else if (error.message.includes('email') || error.message.includes('Email')) {
                        // Email already exists
                        errorMessage.textContent = 'Cette adresse email est déjà utilisée. Veuillez utiliser une autre adresse ou réinitialiser votre mot de passe.';
                    } else {
                        // Generic error
                        errorMessage.textContent = error.message;
                    }
                    
                    errorMessage.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'S\'inscrire';
                }
            });
            
            function validateForm() {
                // Password validation
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (password !== confirmPassword) {
                    errorMessage.textContent = 'Les mots de passe ne correspondent pas';
                    errorMessage.style.display = 'block';
                    return false;
                }
                
                if (password.length < 8) {
                    errorMessage.textContent = 'Le mot de passe doit contenir au moins 8 caractères';
                    errorMessage.style.display = 'block';
                    return false;
                }
                
                // Email validation
                const email = document.getElementById('email').value;
                if (!email.includes('@')) {
                    errorMessage.textContent = 'Veuillez entrer une adresse email valide';
                    errorMessage.style.display = 'block';
                    return false;
                }
                
                // Date validation
                if (!document.getElementById('jour').value || 
                    !document.getElementById('mois').value || 
                    !document.getElementById('annee').value) {
                    errorMessage.textContent = 'Veuillez sélectionner une date de naissance complète';
                    errorMessage.style.display = 'block';
                    return false;
                }
                
                return true;
            }
        });
    </script>
</body>
</html>
