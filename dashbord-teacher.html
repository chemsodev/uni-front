<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Enseignant</title>
    <link href="style/dashbord-teacher.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="js/enseignant-auth.js"></script>
    <script src="js/sidebar-loader.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
       <div id="navbar-container"></div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header header-actions">
                <h1 class="page-title">Espace Enseignant</h1>
                <div class="header-buttons">
                    <button onclick="window.location.href='enseignant-demandes.html'" class="btn-primary">
                        <i class="fas fa-clipboard-list"></i> Gérer les demandes
                    </button>
                    <button onclick="window.location.href='emploi.html'" class="btn-secondary">
                        <i class="fas fa-calendar-alt"></i> Emploi du temps
                    </button>
                </div>
            </div>
            
            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h2 id="total-students">--</h2>
                        <p>Étudiants</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="stat-info">
                        <h2 id="total-sections">--</h2>
                        <p>Sections</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <h2 id="pending-requests">--</h2>
                        <p>Demandes en attente</p>
                    </div>
                    </div>
                </div>
                
            <!-- Main dashboard content -->
            <div class="dashboard-content">
                <!-- Sections panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-layer-group"></i> Mes Sections</h2>
                        <div class="panel-actions">
                            <button id="refreshSectionsBtn" class="btn-icon">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="panel-body" id="sectionsList">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                
                <!-- Section details and student management panel -->
                <div class="panel section-details-panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-users"></i> <span id="sectionDetailsTitle">Étudiants</span></h2>
                        <div class="panel-actions">
                            <div class="search-container">
                                <input type="text" id="student-search" placeholder="Rechercher un étudiant...">
                                <button id="searchBtn"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body" id="sectionStudentsList">
                        <div class="no-section-selected">
                            <i class="fas fa-hand-point-left"></i>
                            <p>Sélectionnez une section pour afficher ses étudiants</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let authToken = null;
      let isBackendAvailable = true; 
      let currentSectionId = null;
      let allSections = [];
      let allStudents = {};
      let stats = {
          students: 0,
          sections: 0,
          requests: 0
      };

      document.addEventListener("DOMContentLoaded", async function () {
        // Load navigation using the sidebar loader
        await loadTeacherSidebar();

        try {
          // Verify authentication using our helper
          const authResult = await verifyEnseignantAuth();
          
          if (!authResult.isAuthenticated) {
            return; // The helper will redirect to login
          }
          
          // Set global variables
          currentUser = authResult.user;
          authToken = sessionStorage.getItem("enseignant_token") || localStorage.getItem("enseignant_token");

          // Load dashboard data
              try {
                await loadUserData();
                await loadDashboardData();
              } catch (dataError) {
                console.error("Error loading data:", dataError);
                isBackendAvailable = false;
                loadFallbackData();
                addReconnectionButton();
              }
          
          // Set up event listeners
          document.getElementById('refreshSectionsBtn').addEventListener('click', refreshSections);
          document.getElementById('searchBtn').addEventListener('click', searchStudents);
          document.getElementById('student-search').addEventListener('keyup', function(e) {
            if(e.key === 'Enter') {
                searchStudents();
            }
          });
        } catch (error) {
          console.error("Access denied:", error);
          logout(); // Use our shared logout function
        }
      });

      // Add reconnection button
      function addReconnectionButton() {
        const offlineNotice = document.querySelector(".alert.alert-warning");

        if (!offlineNotice) {
          const offlineNotice = document.createElement("div");
          offlineNotice.className = "alert alert-warning";
          offlineNotice.style.padding = "10px";
          offlineNotice.style.margin = "10px 0";
          offlineNotice.style.backgroundColor = "#fff3cd";
          offlineNotice.style.color = "#856404";
          offlineNotice.style.borderRadius = "4px";
          offlineNotice.innerHTML =
            "<strong>Mode hors ligne:</strong> Le serveur est actuellement indisponible. Certaines fonctionnalités sont limitées.";
          
          const reconnectBtn = document.createElement("button");
          reconnectBtn.textContent = "Réessayer la connexion";
          reconnectBtn.style.marginLeft = "10px";
          reconnectBtn.style.padding = "5px 10px";
          reconnectBtn.style.backgroundColor = "#007bff";
          reconnectBtn.style.color = "#fff";
          reconnectBtn.style.border = "none";
          reconnectBtn.style.borderRadius = "4px";
          reconnectBtn.style.cursor = "pointer";
          reconnectBtn.onclick = function () {
            window.location.reload();
          };

          offlineNotice.appendChild(reconnectBtn);
          document.querySelector(".main-content").prepend(offlineNotice);
        }
      }

      // Load user data
      async function loadUserData() {
        try {
          // Use the enhanced getCurrentTeacherData function from the auth helper
          const user = getCurrentTeacherData();

          if (!user) {
            console.error("No user data available");
            throw new Error("User data not available");
          }
          
          console.log("Teacher data loaded:", user);
          
          // Make sure we save complete user data for other pages
          const storage = localStorage.getItem("enseignant_token") ? localStorage : sessionStorage;
                storage.setItem("enseignantData", JSON.stringify(user));
          
          // Update sidebar elements
          updateSidebarUserInfo(user);
          
          return user;
            } catch (error) {
          console.error("Error loading user data:", error);
          
          // Even in case of error, try to display something reasonable in the sidebar
          updateSidebarUserInfo({
            prenom: "Enseignant",
            nom: "Utilisateur",
            matricule: "ENS000"
          });
          
          if (error.name === "AbortError" || error.message.includes("Failed to fetch")) {
            isBackendAvailable = false;
          }
        }
      }

      // Helper function to update sidebar user information
      function updateSidebarUserInfo(user) {
        if (!user) return;

          // Update UI with user data if elements exist
          if (document.getElementById("userFullName")) {
            document.getElementById("userFullName").textContent =
              `${user.prenom || ""} ${user.nom || ""}`.trim() || "Enseignant";
          }
          
          if (document.getElementById("userId")) {
          document.getElementById("userId").textContent = user.matricule || "N/A";
          }

          if (document.getElementById("userAvatar")) {
            document.getElementById("userAvatar").textContent = 
              `${(user.prenom || " ").charAt(0)}${(user.nom || " ").charAt(0)}`.toUpperCase();
        }
      }

      // Load dashboard data
      async function loadDashboardData() {
        try {
            await Promise.all([
                loadSections(),
                loadPendingRequests()
            ]);
            
            // Update stats
            updateStatistics();
        } catch (error) {
            console.error("Error loading dashboard data:", error);
            loadFallbackData();
        }
      }
      
      // Load sections
      async function loadSections() {
        try {
            const sections = await loadTeacherSections();
            allSections = sections;
            stats.sections = sections.length;
            
            // Calculate total students across all sections
            let totalStudents = 0;
            sections.forEach(section => {
                const occupancy = section.groupes ? section.groupes.reduce((sum, groupe) => 
                    sum + (groupe.currentOccupancy || 0), 0) : 0;
                totalStudents += occupancy;
            });
            stats.students = totalStudents;
            
            renderSections(sections);
            return sections;
        } catch (error) {
            console.error("Error loading sections:", error);
            throw error;
        }
      }
      
      // Refresh sections data
      async function refreshSections() {
        const refreshBtn = document.getElementById('refreshSectionsBtn');
        refreshBtn.innerHTML = '<i class="fas fa-spin fa-spinner"></i>';
        refreshBtn.disabled = true;
        
        try {
            // Clear session storage to force a fresh fetch
            sessionStorage.removeItem("teacherSections");
            await loadSections();
            
            // If a section was selected, refresh its students
            if (currentSectionId) {
                await loadSectionStudents(currentSectionId);
            }
            
            // Update stats
            updateStatistics();
        } catch (error) {
            console.error("Error refreshing sections:", error);
        } finally {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            refreshBtn.disabled = false;
        }
      }
      
      // Load pending requests count
      async function loadPendingRequests() {
        try {
            if (!isBackendAvailable) {
                stats.requests = 2; // Fallback
                return;
            }
            
            const response = await fetch(
                "http://localhost:3000/api/enseignants/group-change-requests",
                {
                    headers: { Authorization: `Bearer ${authToken}` },
                    signal: AbortSignal.timeout(5000)
                }
            );
            
            if (response.ok) {
                const requests = await response.json();
                // Only count pending requests
                const pendingRequests = requests.filter(req => req.status === 'pending');
                stats.requests = pendingRequests.length;
                return pendingRequests.length;
            } else {
                console.warn(`Error loading requests: ${response.status}`);
                stats.requests = 0;
            }
        } catch (error) {
            console.error("Error loading pending requests:", error);
            stats.requests = 0;
        }
      }
      
      // Load students for a specific section
      async function loadSectionStudents(sectionId) {
        try {
            // Set the current section
            currentSectionId = sectionId;
            
            // Find the section in our cached data
            const section = allSections.find(s => s.id === sectionId);
            if (!section) {
                throw new Error(`Section ${sectionId} not found`);
            }
            
            // Update section details title
            document.getElementById('sectionDetailsTitle').textContent = `Étudiants - ${section.specialty} ${section.name}`;
            
            // Show loading state
            document.getElementById('sectionStudentsList').innerHTML = '<div class="loading-spinner"></div>';
            
            // Check if we already have this section's students cached
            if (allStudents[sectionId]) {
                renderSectionStudents(allStudents[sectionId], section);
                return allStudents[sectionId];
            }
            
            // Get teacher ID
            const teacherId = currentUser.userId;
            
            if (!isBackendAvailable) {
                const mockStudents = generateMockStudents(10, section);
                allStudents[sectionId] = mockStudents;
                renderSectionStudents(mockStudents, section);
                return mockStudents;
            }
            
            const response = await fetch(
                `http://localhost:3000/api/enseignants/${teacherId}/sections/${sectionId}/students`,
                {
                    headers: { Authorization: `Bearer ${authToken}` },
                    signal: AbortSignal.timeout(5000)
                }
            );
            
            if (response.ok) {
                const students = await response.json();
                allStudents[sectionId] = students;
                renderSectionStudents(students, section);
                return students;
            } else {
                console.warn(`Error loading students: ${response.status}`);
                document.getElementById('sectionStudentsList').innerHTML = 
                    '<div class="error-message">Erreur lors du chargement des étudiants</div>';
            }
        } catch (error) {
            console.error(`Error loading students for section ${sectionId}:`, error);
            document.getElementById('sectionStudentsList').innerHTML = 
                '<div class="error-message">Erreur lors du chargement des étudiants</div>';
        }
      }

      // Render sections
      function renderSections(sections) {
        const container = document.getElementById("sectionsList");
        container.innerHTML = "";

        if (!sections || sections.length === 0) {
          container.innerHTML = '<div class="empty-state">Aucune section assignée</div>';
          return;
        }

        const list = document.createElement("div");
        list.className = "sections-grid";
        
        sections.forEach((section) => {
          // Calculate total occupancy from all groups
          const totalOccupancy = section.groupes ? section.groupes.reduce((sum, groupe) => 
            sum + (groupe.currentOccupancy || 0), 0) : 0;
          
          // Group counts by type
          const tdGroups = section.groupes ? section.groupes.filter(g => g.type === 'td').length : 0;
          const tpGroups = section.groupes ? section.groupes.filter(g => g.type === 'tp').length : 0;
          
          const card = document.createElement("div");
          card.className = "section-card";
          if (currentSectionId === section.id) {
              card.classList.add("active");
          }
          
          card.innerHTML = `
            <div class="section-card-header">
                <h3>${section.specialty || 'Filière'}</h3>
                <span class="section-badge">Section ${section.name || ''}</span>
            </div>
            <div class="section-card-body">
                <div class="section-info">
                    <div class="info-item">
                        <i class="fas fa-users"></i>
                        <span>${totalOccupancy} étudiants</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-layer-group"></i>
                        <span>${tdGroups} TD, ${tpGroups} TP</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-code"></i>
                        <span>Code: ${section.code || 'N/A'}</span>
                    </div>
                </div>
            </div>
            <div class="section-card-footer">
                <button class="btn-view-students">Voir les étudiants</button>
            </div>
          `;
          
          // Add click handler
          card.querySelector('.btn-view-students').addEventListener('click', () => {
              // Mark this card as active and remove active from others
              document.querySelectorAll('.section-card.active').forEach(el => el.classList.remove('active'));
              card.classList.add('active');
              
              // Load the students for this section
              loadSectionStudents(section.id);
          });
          
          list.appendChild(card);
        });
        
        container.appendChild(list);
      }

      // Render students for a section
      function renderSectionStudents(students, section) {
        const container = document.getElementById('sectionStudentsList');
        container.innerHTML = '';
        
        if (!students || students.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users-slash"></i>
                    <p>Aucun étudiant dans cette section</p>
                </div>
            `;
          return;
        }

        // Pagination setup
        const itemsPerPage = 10;
        const totalPages = Math.ceil(students.length / itemsPerPage);
        let currentPage = 1;
        
        // Create a table for students
        const table = document.createElement('table');
        table.className = 'students-table';
        
        // Table header
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
                <th>Nom & Prénom</th>
            <th>Matricule</th>
            <th>Groupe TD</th>
            <th>Groupe TP</th>
                <th>Actions</th>
          </tr>
        `;
        table.appendChild(thead);
        
        // Table body
        const tbody = document.createElement('tbody');
        table.appendChild(tbody);
        
        // Function to render a specific page
        function renderPage(page) {
            currentPage = page;
            tbody.innerHTML = '';
            
            const start = (page - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, students.length);
            const pageStudents = students.slice(start, end);
            
            pageStudents.forEach(student => {
                const row = document.createElement('tr');
                
                // Find TD and TP groups if available
                let tdGroup = 'Non assigné';
                let tpGroup = 'Non assigné';
                
                if (student.tdGroupe) {
                    tdGroup = `Groupe ${student.tdGroupe.name}`;
                }
                
                if (student.tpGroupe) {
                    tpGroup = `Groupe ${student.tpGroupe.name}`;
                }
                
          row.innerHTML = `
                    <td>
                        <div class="student-name">
                            <div class="student-avatar">${student.firstName.charAt(0)}${student.lastName.charAt(0)}</div>
                            <div>
                                <div class="full-name">${student.lastName} ${student.firstName}</div>
                                <div class="email">${student.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>${student.matricule}</td>
                    <td><span class="group-badge">${tdGroup}</span></td>
                    <td><span class="group-badge">${tpGroup}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view-profile" title="Voir profil">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="btn-icon btn-view-grades" title="Voir notes">
                                <i class="fas fa-graduation-cap"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Add event listeners for actions
                row.querySelector('.btn-view-profile').addEventListener('click', () => {
                    // Open student profile
                    alert(`Affichage du profil de ${student.firstName} ${student.lastName} à implémenter`);
                });
                
                row.querySelector('.btn-view-grades').addEventListener('click', () => {
                    // View student grades
                    alert(`Affichage des notes de ${student.firstName} ${student.lastName} à implémenter`);
                });
                
          tbody.appendChild(row);
        });
            
            // Update pagination UI
            updatePaginationUI();
        }
        
        // Create pagination container
        const pagination = document.createElement('div');
        pagination.className = 'pagination-container';
        
        // Function to update pagination UI
        function updatePaginationUI() {
            pagination.innerHTML = '';
            
            // Info text
            const pageInfo = document.createElement('div');
            pageInfo.className = 'pagination-info';
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, students.length);
            pageInfo.textContent = `Affichage ${start}-${end} sur ${students.length} étudiants`;
            pagination.appendChild(pageInfo);
            
            // Page buttons
            const pageButtons = document.createElement('div');
            pageButtons.className = 'pagination-buttons';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn prev';
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) renderPage(currentPage - 1);
            });
            pageButtons.appendChild(prevButton);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-btn page-number';
                if (i === currentPage) pageBtn.classList.add('active');
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => renderPage(i));
                pageButtons.appendChild(pageBtn);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn next';
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) renderPage(currentPage + 1);
            });
            pageButtons.appendChild(nextButton);
            
            pagination.appendChild(pageButtons);
        }
        
        container.appendChild(table);
        container.appendChild(pagination);
        
        // Add export/print options
        const actionBar = document.createElement('div');
        actionBar.className = 'student-list-actions';
        actionBar.innerHTML = `
            <button class="btn-secondary btn-export-excel">
                <i class="fas fa-file-excel"></i> Exporter Excel
            </button>
            <button class="btn-secondary btn-print">
                <i class="fas fa-print"></i> Imprimer
            </button>
        `;
        
        // Add event listeners for export/print
        actionBar.querySelector('.btn-export-excel').addEventListener('click', () => {
            alert(`Export Excel pour ${section.name} à implémenter`);
        });
        
        actionBar.querySelector('.btn-print').addEventListener('click', () => {
            alert(`Impression de la liste pour ${section.name} à implémenter`);
        });
        
        container.appendChild(actionBar);
        
        // Render the first page
        renderPage(1);
      }
      
      // Search students
      function searchStudents() {
        const searchTerm = document.getElementById('student-search').value.toLowerCase().trim();
        
        if (!currentSectionId) {
            // If no section is selected, show a message
            document.getElementById('sectionStudentsList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-hand-point-left"></i>
                    <p>Sélectionnez une section pour afficher ses étudiants</p>
                </div>
            `;
            return;
        }
        
        if (!searchTerm) {
            // If search term is empty, show all students
            const section = allSections.find(s => s.id === currentSectionId);
            const students = allStudents[currentSectionId] || [];
            renderSectionStudents(students, section);
            return;
        }
        
        // Get students for the current section
        const students = allStudents[currentSectionId] || [];
        if (students.length === 0) {
            document.getElementById('sectionStudentsList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-slash"></i>
                    <p>Aucun étudiant trouvé dans cette section</p>
                </div>
            `;
            return;
        }
        
        // Filter students based on search term with null checks
        const filteredStudents = students.filter(student => {
            return (student.firstName || '').toLowerCase().includes(searchTerm) ||
                   (student.lastName || '').toLowerCase().includes(searchTerm) ||
                   (student.matricule || '').toLowerCase().includes(searchTerm) ||
                   (student.email || '').toLowerCase().includes(searchTerm) ||
                   (`${student.firstName || ''} ${student.lastName || ''}`).toLowerCase().includes(searchTerm);
        });
        
        // Find the section for rendering
        const section = allSections.find(s => s.id === currentSectionId);
        
        // Render filtered students
        renderSectionStudents(filteredStudents, section);
        
        // Show search results message
        const container = document.getElementById('sectionStudentsList');
        const resultsMsg = document.createElement('div');
        resultsMsg.className = 'search-results-msg';
        resultsMsg.innerHTML = `
            <p>Résultats pour "${searchTerm}": ${filteredStudents.length} étudiant(s) trouvé(s)</p>
            <button class="btn-text btn-clear-search">Effacer la recherche</button>
        `;
        
        // Add event listener to clear search
        resultsMsg.querySelector('.btn-clear-search').addEventListener('click', () => {
            document.getElementById('student-search').value = '';
            renderSectionStudents(students, section);
        });
        
        // Insert at the beginning
        container.insertBefore(resultsMsg, container.firstChild);
      }

      // Render notifications
      function renderNotifications(notifications) {
        const container = document.getElementById("notificationsList");
        container.innerHTML = "";

        if (!notifications || notifications.length === 0) {
          container.innerHTML = '<div class="empty-state">Aucune notification récente</div>';
          return;
        }

        const recentNotifications = notifications.slice(0, 3);
        const list = document.createElement('div');
        list.className = 'notification-list';

        recentNotifications.forEach((notif) => {
          const div = document.createElement("div");
          div.className = "notification-item";
          
          // Format time
          const timeAgo = formatTimeAgo(notif.createdAt);
          
          div.innerHTML = `
            <div class="notification-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="notification-content">
                <h4>${notif.title}</h4>
            <p>${notif.message}</p>
                <span class="notification-time">${timeAgo}</span>
            </div>
          `;
          list.appendChild(div);
        });
        
        container.appendChild(list);
      }
      
      // Update statistics in UI
      function updateStatistics() {
        document.getElementById('total-students').textContent = stats.students;
        document.getElementById('total-sections').textContent = stats.sections;
        document.getElementById('pending-requests').textContent = stats.requests;
      }

      // Load fallback data when backend is unavailable
      function loadFallbackData() {
        addReconnectionButton();

        // Sample sections data
        const sampleSections = [
          {
            id: "sect1",
            filiere: "Informatique",
            specialty: "Informatique",
            name: "B",
            code: "INF-3B",
            level: "3ème année",
            nombreEtudiants: 32,
            groupes: [
                { type: "td", name: "1", currentOccupancy: 16 },
                { type: "td", name: "2", currentOccupancy: 16 },
                { type: "tp", name: "1", currentOccupancy: 10 },
                { type: "tp", name: "2", currentOccupancy: 12 },
                { type: "tp", name: "3", currentOccupancy: 10 }
            ]
          },
          {
            id: "sect2",
            filiere: "Mathématiques",
            specialty: "Mathématiques",
            name: "A",
            code: "MATH-2A",
            level: "2ème année",
            nombreEtudiants: 28,
            groupes: [
                { type: "td", name: "1", currentOccupancy: 14 },
                { type: "td", name: "2", currentOccupancy: 14 },
                { type: "tp", name: "1", currentOccupancy: 14 },
                { type: "tp", name: "2", currentOccupancy: 14 }
            ]
          }
        ];
        allSections = sampleSections;
        stats.sections = sampleSections.length;
        
        // Count total students
        let totalStudents = 0;
        sampleSections.forEach(section => {
            const occupancy = section.groupes ? section.groupes.reduce((sum, groupe) => 
                sum + (groupe.currentOccupancy || 0), 0) : 0;
            totalStudents += occupancy;
        });
        stats.students = totalStudents;
        
        renderSections(sampleSections);
        
        // Set pending requests count
        stats.requests = 2;
        
        // Update statistics
        updateStatistics();
      }
      
      // Generate mock students for testing
      function generateMockStudents(count, section) {
        const students = [];
        const firstNames = ["Ahmed", "Sara", "Mohamed", "Fatima", "Youssef", "Yasmine", "Omar", "Lina", "Nour", "Amine"];
        const lastNames = ["Benali", "Taleb", "Bouazizi", "Khelifi", "Mansouri", "Rahmani", "Ziani", "Hadj", "Benmoussa", "Abid"];
        
        for (let i = 0; i < count; i++) {
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            
            // Generate TD and TP groups
            const tdGroups = section.groupes.filter(g => g.type === 'td');
            const tpGroups = section.groupes.filter(g => g.type === 'tp');
            
            const tdGroup = tdGroups.length > 0 ? tdGroups[Math.floor(Math.random() * tdGroups.length)] : null;
            const tpGroup = tpGroups.length > 0 ? tpGroups[Math.floor(Math.random() * tpGroups.length)] : null;
            
            students.push({
                id: `stud${i+1}`,
                firstName: firstName,
                lastName: lastName,
                matricule: `202${Math.floor(Math.random() * 10000)}`,
                email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`,
                phone: `+213 5${Math.floor(Math.random() * 10000000)}`,
                tdGroupe: tdGroup,
                tpGroupe: tpGroup
            });
        }
        
        return students;
      }

      // Helper functions
      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return "à l'instant";
        if (diffMins < 60) return `il y a ${diffMins} min`;
        if (diffHours < 24) return `il y a ${diffHours}h`;
        if (diffDays < 7) return `il y a ${diffDays}j`;
        return formatDate(dateString);
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("fr-FR", {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        });
      }

      // Logout function
      async function logout() {
        try {
          // No need for server logout - just clear local storage
          console.log("Logging out...");
        } catch (error) {
          console.error("Logout error:", error);
        } finally {
          sessionStorage.removeItem("enseignantData");
          sessionStorage.removeItem("enseignant_token");
          sessionStorage.removeItem("enseignantUserData");
          sessionStorage.removeItem("teacherSections");
          localStorage.removeItem("enseignantData");
          localStorage.removeItem("enseignant_token");
          window.location.href = "enseignant-login.html";
        }
      }
    </script>
</body>
</html>