<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Gestion des demandes de modification de profil - Administration
    </title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sora:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link href="style/admin.css" rel="stylesheet" />
    <link href="style/section-statistics.css" rel="stylesheet" />
    <script src="js/admin-auth.js"></script>
    <script src="js/admin-pages-validation.js"></script>
    <script src="js/admin-mocks.js"></script>
    <script src="js/admin-api-utils.js"></script>
    <script src="js/admin-api-fetchers.js"></script>
    <script src="js/admin-api-loader.js"></script>
    <script src="js/section-statistics.js"></script>
    <!-- Chart.js for statistics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .user-info {
        display: flex;
        align-items: center;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 10px;
      }

      .user-details span {
        display: block;
      }

      .user-name {
        font-weight: 600;
      }

      .user-email {
        color: var(--gray-color);
        font-size: 0.85rem;
      }

      .request-status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .status-pending {
        background-color: #fef3c7;
        color: #d97706;
      }

      .status-approved {
        background-color: #d1fae5;
        color: #059669;
      }

      .status-rejected {
        background-color: #fee2e2;
        color: #dc2626;
      }

      .field-change {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f0f0f0;
      }

      .field-change:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .field-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .field-comparison {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .field-old,
      .field-new {
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
        flex: 1;
        min-width: 200px;
      }

      .field-old {
        background-color: #f1f5f9;
        color: #64748b;
      }

      .field-new {
        background-color: #e0f2fe;
        color: #0369a1;
      }

      .document-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
        font-size: 0.875rem;
        text-decoration: none;
        margin-top: 0.5rem;
      }

      .document-link:hover {
        text-decoration: underline;
      }

      .compare-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-color);
        padding: 0 0.5rem;
      }

      .notes-field {
        min-height: 100px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar - will be loaded via JavaScript -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">Gestion des Demandes de Profil</h1>
        </div>

        <div class="content-container">
          <!-- Status Messages -->
          <div
            id="status-message"
            class="status-message"
            style="display: none"
          ></div>

          <!-- Dashboard Cards -->
          <div class="cards-grid">
            <!-- Total Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-card-value" id="total-requests">--</div>
              <div class="stat-card-description">Toutes les demandes</div>
            </div>

            <!-- Pending Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
              </div>
              <div class="stat-card-value" id="pending-requests">--</div>
              <div class="stat-card-description">En attente</div>
            </div>

            <!-- Approved Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
              <div class="stat-card-value" id="approved-requests">--</div>
              <div class="stat-card-description">Approuvées</div>
            </div>

            <!-- Rejected Requests Card -->
            <div class="stat-card">
              <div class="stat-card-header">
                <svg
                  class="stat-card-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </div>
              <div class="stat-card-value" id="rejected-requests">--</div>
              <div class="stat-card-description">Rejetées</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="filters">
            <div class="filter-item">
              <label for="request-type-filter">Type d'utilisateur</label>
              <select id="request-type-filter" class="filter-select">
                <option value="all">Tous</option>
                <option value="student">Étudiants</option>
                <option value="teacher">Enseignants</option>
              </select>
            </div>
            <div class="filter-item">
              <label for="status-filter">Statut</label>
              <select id="status-filter" class="filter-select">
                <option value="all">Tous</option>
                <option value="pending">En attente</option>
                <option value="approved">Approuvée</option>
                <option value="rejected">Rejetée</option>
              </select>
            </div>
            <div class="filter-item">
              <label for="search">Recherche</label>
              <input
                type="text"
                id="search"
                class="filter-input"
                placeholder="Nom, email..."
              />
            </div>
          </div>

          <!-- Profile Requests Table -->
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Utilisateur</th>
                  <th>Type</th>
                  <th>Champs Modifiés</th>
                  <th>Date de Demande</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requests-table-body">
                <tr>
                  <td colspan="6" class="text-center">
                    Chargement des demandes...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination" id="pagination">
            <!-- Pagination will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Request Details Modal -->
    <div id="request-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 class="modal-title">Détails de la Demande</h2>

        <div class="user-info">
          <div id="user-avatar" class="user-avatar">JD</div>
          <div class="user-details">
            <span id="user-name" class="user-name">John Doe</span>
            <span id="user-email" class="user-email">john.doe@example.com</span>
          </div>
        </div>

        <div class="details-container" style="margin-top: 1.5rem">
          <div class="detail-row">
            <div class="detail-label">Type d'utilisateur:</div>
            <div id="user-type" class="detail-value">Étudiant</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Date de Demande:</div>
            <div id="request-date" class="detail-value">01/01/2023</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Statut:</div>
            <div
              id="request-status"
              class="detail-value request-status status-pending"
            >
              En attente
            </div>
          </div>
        </div>

        <div class="request-details" style="margin-top: 1.5rem">
          <h3>Modifications Demandées</h3>

          <div id="fields-container">
            <!-- Field changes will be added here dynamically -->
            <div class="field-change">
              <div class="field-name">Téléphone</div>
              <div class="field-comparison">
                <div class="field-old">+213 555 123 456</div>
                <div class="compare-arrow">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M5 12h14"></path>
                    <path d="m12 5 7 7-7 7"></path>
                  </svg>
                </div>
                <div class="field-new">+213 555 789 012</div>
              </div>
            </div>

            <div class="field-change">
              <div class="field-name">Adresse</div>
              <div class="field-comparison">
                <div class="field-old">
                  123 Rue des Palmiers, Alger, Algérie
                </div>
                <div class="compare-arrow">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M5 12h14"></path>
                    <path d="m12 5 7 7-7 7"></path>
                  </svg>
                </div>
                <div class="field-new">456 Avenue du Sahara, Oran, Algérie</div>
              </div>
            </div>
          </div>

          <div id="document-container" style="margin-top: 1rem; display: none">
            <h3>Document Justificatif</h3>
            <a
              id="document-link"
              href="#"
              class="document-link"
              target="_blank"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                ></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span id="document-name">document.pdf</span>
            </a>
          </div>
        </div>

        <div
          id="admin-response-container"
          class="request-details"
          style="display: none"
        >
          <h3>Réponse Administrative</h3>
          <p id="admin-response-text"></p>
        </div>

        <div
          id="action-buttons"
          class="modal-actions"
          style="margin-top: 1.5rem"
        >
          <textarea
            id="admin-comment"
            class="notes-field"
            placeholder="Ajouter un commentaire (optionnel)"
          ></textarea>

          <div style="display: flex; gap: 0.75rem; margin-top: 1rem">
            <button id="approve-btn" class="btn btn-success">
              Approuver les modifications
            </button>
            <button id="reject-btn" class="btn btn-danger">
              Rejeter les modifications
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let allRequests = [];
      let filteredRequests = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentRequest = null;

      // DOM Elements
      const statusMessage = document.getElementById("status-message");
      const requestsTableBody = document.getElementById("requests-table-body");
      const paginationElement = document.getElementById("pagination");
      const requestTypeFilter = document.getElementById("request-type-filter");
      const statusFilter = document.getElementById("status-filter");
      const searchInput = document.getElementById("search");

      // Stats elements
      const totalRequestsEl = document.getElementById("total-requests");
      const pendingRequestsEl = document.getElementById("pending-requests");
      const approvedRequestsEl = document.getElementById("approved-requests");
      const rejectedRequestsEl = document.getElementById("rejected-requests");

      // Modal elements
      const requestModal = document.getElementById("request-modal");
      const closeModalBtn = document.querySelector(".close-modal");
      const userAvatar = document.getElementById("user-avatar");
      const userName = document.getElementById("user-name");
      const userEmail = document.getElementById("user-email");
      const userType = document.getElementById("user-type");
      const requestDate = document.getElementById("request-date");
      const requestStatus = document.getElementById("request-status");
      const fieldsContainer = document.getElementById("fields-container");
      const documentContainer = document.getElementById("document-container");
      const documentLink = document.getElementById("document-link");
      const documentName = document.getElementById("document-name");
      const adminResponseContainer = document.getElementById(
        "admin-response-container"
      );
      const adminResponseText = document.getElementById("admin-response-text");
      const actionButtons = document.getElementById("action-buttons");
      const adminComment = document.getElementById("admin-comment");
      const approveBtn = document.getElementById("approve-btn");
      const rejectBtn = document.getElementById("reject-btn");

      // Event listeners
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Verify admin token first
          await verifyAdminToken();

          // Load sidebar and data
          await loadSidebar();
          await loadRequests();
          setupEventListeners();
        } catch (error) {
          console.error("Error initializing page:", error);
          showMessage("Erreur lors du chargement de la page", "error");
        }
      });

      async function loadSidebar() {
        try {
          const response = await fetch("admin-sidebar.html");
          if (!response.ok) throw new Error("Failed to load sidebar");

          const html = await response.text();
          document.getElementById("sidebar-container").innerHTML = html;

          // Initialize sidebar scripts if they exist
          if (window.updateAdminInfo) {
            window.updateAdminInfo();
          }

          if (window.setActiveMenuItem) {
            window.setActiveMenuItem();
          }
        } catch (error) {
          console.error("Error loading sidebar:", error);
        }
      }
      async function loadRequests() {
        try {
          showMessage("Chargement des demandes...", "info");

          // Use our consistent function from admin-api-fetchers.js
          const data = await fetchProfileRequestsAPI();

          // Handle the response structure consistently
          allRequests = Array.isArray(data.requests)
            ? data.requests
            : Array.isArray(data)
            ? data
            : [];

          if (!data.success && !allRequests.length) {
            // Fall back to direct apiCall if the API function fails
            const response = await apiCall("profile-requests");

            if (!response || !response.data) {
              // No mock data in production environment
              throw new Error(
                "Failed to fetch profile requests - server may be unavailable."
              );
            } else {
              allRequests = response.data; // Extract data from apiCall's response
            }
          }

          // Store the requests and update the UI
          updateStats();
          filterRequests();

          showMessage("Demandes chargées avec succès", "success");
        } catch (error) {
          console.error("Error loading profile requests:", error);
          allRequests = [];
          showMessage("Erreur lors du chargement des demandes", "error");
          requestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center">Erreur lors du chargement des demandes. Veuillez réessayer plus tard.</td></tr>`;
        }
      }

      function updateStats() {
        const stats = {
          total: allRequests.length,
          pending: allRequests.filter((req) => req.status === "pending").length,
          approved: allRequests.filter((req) => req.status === "approved")
            .length,
          rejected: allRequests.filter((req) => req.status === "rejected")
            .length,
        };

        // Update stats cards
        totalRequestsEl.textContent = stats.total;
        pendingRequestsEl.textContent = stats.pending;
        approvedRequestsEl.textContent = stats.approved;
        rejectedRequestsEl.textContent = stats.rejected;
      }

      function setupEventListeners() {
        // Filter change events
        requestTypeFilter.addEventListener("change", filterRequests);
        statusFilter.addEventListener("change", filterRequests);
        searchInput.addEventListener("input", filterRequests);

        // Modal close button
        closeModalBtn.addEventListener("click", closeModal);

        // Outside modal click to close
        window.addEventListener("click", function (event) {
          if (event.target === requestModal) {
            closeModal();
          }
        });

        // Action buttons
        approveBtn.addEventListener("click", () =>
          handleRequestAction("approved")
        );
        rejectBtn.addEventListener("click", () =>
          handleRequestAction("rejected")
        );
      }

      function filterRequests() {
        const typeValue = requestTypeFilter.value;
        const statusValue = statusFilter.value;
        const searchValue = searchInput.value.toLowerCase();

        filteredRequests = allRequests.filter((request) => {
          // Filter by user type
          if (typeValue !== "all" && request.user.type !== typeValue) {
            return false;
          }

          // Filter by status
          if (statusValue !== "all" && request.status !== statusValue) {
            return false;
          }

          // Filter by search term (user name or email)
          if (searchValue) {
            const userName =
              `${request.user.firstName} ${request.user.lastName}`.toLowerCase();
            const userEmail = request.user.email
              ? request.user.email.toLowerCase()
              : "";

            if (
              !userName.includes(searchValue) &&
              !userEmail.includes(searchValue)
            ) {
              return false;
            }
          }

          return true;
        });

        // Reset to first page when filters change
        currentPage = 1;

        // Render the filtered requests
        renderRequests();
      }

      function renderRequests() {
        // Calculate pagination
        const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(
          startIndex + itemsPerPage,
          filteredRequests.length
        );
        const currentItems = filteredRequests.slice(startIndex, endIndex);

        // Clear table
        requestsTableBody.innerHTML = "";

        // Show 'no data' if nothing fetched at all
        if (!allRequests || allRequests.length === 0) {
          requestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center">Aucune demande disponible.</td></tr>`;
          paginationElement.innerHTML = "";
          return;
        }
        // Show 'no match' if filters result in empty
        if (currentItems.length === 0) {
          requestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center">Aucune demande trouvée.</td></tr>`;
          paginationElement.innerHTML = "";
          return;
        }

        // Render each request row
        currentItems.forEach((request) => {
          // Format date
          const requestDate = request.createdAt
            ? new Date(request.createdAt).toLocaleDateString("fr-FR")
            : "-";
          // Create status badge class
          let statusClass = "status-pending";
          let statusText = "En attente";
          if (request.status === "approved") {
            statusClass = "status-approved";
            statusText = "Approuvée";
          } else if (request.status === "rejected") {
            statusClass = "status-rejected";
            statusText = "Rejetée";
          }
          const user = request.user || {};
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.firstName || "-"} ${user.lastName || "-"}</td>
            <td>${user.email || "-"}</td>
            <td>${requestDate}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${request.justification || "-"}</td>
            <td>
              <button class="action-btn view-btn" data-id="${
                request.id
              }" title="Voir">👁️</button>
            </td>
          `;
          requestsTableBody.appendChild(row);
          row
            .querySelector(".view-btn")
            .addEventListener("click", () => openRequestModal(request));
        });

        // Render pagination
        renderPagination(totalPages);
      }

      function renderPagination(totalPages) {
        // Clear pagination
        paginationElement.innerHTML = "";

        // Don't render pagination if there's only one page
        if (totalPages <= 1) return;

        // Add Previous button
        const prevBtn = document.createElement("button");
        prevBtn.classList.add("pagination-btn");
        prevBtn.innerHTML = "&laquo; Précédent";
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            renderRequests();
          }
        });
        paginationElement.appendChild(prevBtn);

        // Add page buttons
        const maxVisiblePages = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust start page if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // First page button if not visible
        if (startPage > 1) {
          const firstBtn = document.createElement("button");
          firstBtn.classList.add("pagination-btn");
          firstBtn.textContent = "1";
          firstBtn.addEventListener("click", () => {
            currentPage = 1;
            renderRequests();
          });
          paginationElement.appendChild(firstBtn);

          // Add ellipsis if there's a gap
          if (startPage > 2) {
            const ellipsis = document.createElement("span");
            ellipsis.classList.add("pagination-ellipsis");
            ellipsis.textContent = "...";
            paginationElement.appendChild(ellipsis);
          }
        }

        // Page buttons
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement("button");
          pageBtn.classList.add("pagination-btn");
          if (i === currentPage) pageBtn.classList.add("active");
          pageBtn.textContent = i;
          pageBtn.addEventListener("click", () => {
            currentPage = i;
            renderRequests();
          });
          paginationElement.appendChild(pageBtn);
        }

        // Last page button if not visible
        if (endPage < totalPages) {
          // Add ellipsis if there's a gap
          if (endPage < totalPages - 1) {
            const ellipsis = document.createElement("span");
            ellipsis.classList.add("pagination-ellipsis");
            ellipsis.textContent = "...";
            paginationElement.appendChild(ellipsis);
          }

          const lastBtn = document.createElement("button");
          lastBtn.classList.add("pagination-btn");
          lastBtn.textContent = totalPages;
          lastBtn.addEventListener("click", () => {
            currentPage = totalPages;
            renderRequests();
          });
          paginationElement.appendChild(lastBtn);
        }

        // Add Next button
        const nextBtn = document.createElement("button");
        nextBtn.classList.add("pagination-btn");
        nextBtn.innerHTML = "Suivant &raquo;";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderRequests();
          }
        });
        paginationElement.appendChild(nextBtn);
      }

      function openRequestDetails(requestId) {
        // Find the request by ID
        const request = allRequests.find((req) => req.id == requestId);

        if (!request) {
          showMessage("Demande introuvable", "error");
          return;
        }

        // Store current request for action handlers
        currentRequest = request; // Set user details with null checks
        const userFirstName =
          request.user && request.user.firstName ? request.user.firstName : "U";
        const userLastName =
          request.user && request.user.lastName ? request.user.lastName : "U";
        const userInitials = `${userFirstName[0]}${userLastName[0]}`;

        userAvatar.textContent = userInitials;
        userName.textContent = `${userFirstName} ${userLastName}`;
        userEmail.textContent = (request.user && request.user.email) || "N/A";

        const userType =
          request.user && request.user.type ? request.user.type : "unknown";
        userType.textContent =
          userType === "student"
            ? "Étudiant"
            : userType === "teacher"
            ? "Enseignant"
            : "Utilisateur";

        // Set request details
        requestDate.textContent = new Date(
          request.createdAt
        ).toLocaleDateString("fr-FR");

        // Set status
        let statusClass = "status-pending";
        let statusText = "En attente";

        if (request.status === "approved") {
          statusClass = "status-approved";
          statusText = "Approuvée";
        } else if (request.status === "rejected") {
          statusClass = "status-rejected";
          statusText = "Rejetée";
        }

        requestStatus.textContent = statusText;
        requestStatus.className = `request-status ${statusClass}`; // Set field changes with null checks
        fieldsContainer.innerHTML = "";
        if (
          request.changes &&
          Array.isArray(request.changes) &&
          request.changes.length > 0
        ) {
          request.changes.forEach((change) => {
            const fieldDiv = document.createElement("div");
            fieldDiv.className = "field-change";
            fieldDiv.innerHTML = `
            <div class="field-name">${formatFieldName(change.field)}</div>
            <div class="field-comparison">
              <div class="field-old">${change.oldValue || "Non spécifié"}</div>
              <div class="compare-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12h14"></path>
                  <path d="m12 5 7 7-7 7"></path>
                </svg>
              </div>
              <div class="field-new">${change.newValue || "Non spécifié"}</div>
            </div>
          `;
            fieldsContainer.appendChild(fieldDiv);
          });

          // Check if there's a supporting document
          if (request.documentUrl) {
            documentContainer.style.display = "block";
            documentLink.href = request.documentUrl;
            documentName.textContent =
              request.documentName || "Document justificatif";
          } else {
            documentContainer.style.display = "none";
          }

          // Handle admin response display
          if (request.adminResponse) {
            adminResponseContainer.style.display = "block";
            adminResponseText.textContent = request.adminResponse;
          } else {
            adminResponseContainer.style.display = "none";
          }

          // Show/hide action buttons based on status
          actionButtons.style.display =
            request.status === "pending" ? "block" : "none";

          // Clear comment field
          adminComment.value = "";

          // Open the modal
          requestModal.style.display = "block";
        }
      }

      function formatFieldName(fieldName) {
        const fieldMap = {
          firstName: "Prénom",
          lastName: "Nom",
          email: "Email",
          phone: "Téléphone",
          address: "Adresse",
          dateOfBirth: "Date de naissance",
          specialty: "Spécialité",
          specialite: "Spécialité",
        };

        return (
          fieldMap[fieldName] ||
          fieldName.charAt(0).toUpperCase() + fieldName.slice(1)
        );
      }

      function closeModal() {
        requestModal.style.display = "none";
        currentRequest = null;
      }

      async function handleRequestAction(status) {
        if (!currentRequest) {
          showMessage("Erreur: Demande non trouvée", "error");
          return;
        }

        try {
          showMessage("Traitement de la demande...", "info");

          let response;
          // Use enhanced adminAPI methods if available
          if (window.adminAPI && window.adminAPI.updateRequestStatus) {
            response = await window.adminAPI.updateRequestStatus(
              currentRequest.id,
              status,
              adminComment.value
            );
          } else {
            // Fallback to direct apiCall if adminAPI is not available
            const requestData = {
              status: status,
              adminResponse: adminComment.value,
            };

            response = await apiCall(
              `profile-requests/${currentRequest.id}/status`,
              "PATCH",
              requestData
            );
          }

          // Update request in local array
          const index = allRequests.findIndex(
            (req) => req.id === currentRequest.id
          );
          if (index !== -1 && response && response.data) {
            allRequests[index] = response.data; // apiCall wraps in data
          }

          // Update UI
          updateStats();
          filterRequests();

          // Close modal
          closeModal();

          // Show success message
          const actionText = status === "approved" ? "approuvées" : "rejetées";
          showMessage(`Modifications ${actionText} avec succès`, "success");
        } catch (error) {
          console.error("Error updating request:", error);
          showMessage(
            `Erreur lors du traitement de la demande: ${error.message}`,
            "error"
          );
        }
      }

      function showMessage(message, type = "info") {
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusMessage.style.display = "block";

        // Hide message after 5 seconds
        setTimeout(() => {
          statusMessage.style.display = "none";
        }, 5000);
      }
    </script>
  </body>
</html>
