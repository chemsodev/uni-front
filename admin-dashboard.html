<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Administration</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sora:wght@400;700&display=swap" rel="stylesheet">
    <link href="style/admin.css" rel="stylesheet">
    <style>
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 15px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(91, 33, 182, 0.1);
        }
        
        .welcome-banner h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .welcome-banner p {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 600px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: var(--gray-color);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .stat-footer {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin-top: auto;
        }
        
        .access-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .access-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .access-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .access-card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
            color: white;
        }
        
        .access-card-body {
            padding: 20px;
        }
        
        .access-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .access-card-description {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 15px;
        }
        
        .access-card-footer {
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .access-card-footer svg {
            width: 18px;
            height: 18px;
            margin-left: 5px;
        }
        
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .activity-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .activity-list {
            list-style: none;
            padding: 0;
        }
        
        .activity-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--gray-color);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div id="navbar-container"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="page-title">Tableau de Bord</h1>
            </div>
            
            <div class="content-container">
                <!-- Status Messages -->
                <div id="status-message" class="status-message" style="display: none;"></div>
                
                <!-- Welcome Banner -->
                <div class="welcome-banner">
                    <h2>Bienvenue, <span id="admin-welcome-name">Administrateur</span></h2>
                    <p>Accédez à toutes les fonctionnalités d'administration depuis ce tableau de bord unifié. Vos accès sont personnalisés selon votre rôle.</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="stats-grid" id="stats-grid">
                    <!-- Stats will be loaded dynamically based on role -->
                </div>
                
                <!-- Access Cards -->
                <h2 class="section-title">Accès Rapides</h2>
                <div class="access-cards" id="access-cards">
                    <!-- Access cards will be loaded dynamically based on role -->
                </div>
                
                <!-- Recent Activity -->
                <div class="recent-activity">
                    <div class="activity-header">
                        <div class="activity-title">Activités Récentes</div>
                    </div>
                    <ul class="activity-list" id="activity-list">
                        <!-- Activities will be loaded dynamically -->
                        <li class="activity-item" style="justify-content: center; padding: 20px;">
                            <span>Chargement des activités récentes...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        const API_BASE_URL = 'https://unicersityback.onrender.com/api';
        let authToken = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token');
        let adminRole = localStorage.getItem('admin_role') || sessionStorage.getItem('admin_role');
        let adminEmail = localStorage.getItem('admin_email') || sessionStorage.getItem('admin_email');
        let adminId = localStorage.getItem('admin_id') || sessionStorage.getItem('admin_id');
        
        // DOM Elements
        const statusMessage = document.getElementById('status-message');
        const adminWelcomeName = document.getElementById('admin-welcome-name');
        const statsGrid = document.getElementById('stats-grid');
        const accessCards = document.getElementById('access-cards');
        const activityList = document.getElementById('activity-list');
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Verify authentication
                if (!authToken || !adminRole) {
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                // Load the sidebar
                await loadSidebar();
                
                // Load dashboard content
                updateWelcomeMessage();
                loadRoleBasedStats();
                loadAccessCards();
                loadRecentActivity();
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Une erreur est survenue lors de l\'initialisation de la page.', 'error');
            }
        });
        
        async function loadSidebar() {
            try {
                const response = await fetch('admin-sidebar.html');
                const html = await response.text();
                document.getElementById('navbar-container').innerHTML = html;
            } catch (error) {
                console.error('Error loading sidebar:', error);
                showMessage('Impossible de charger la barre latérale.', 'error');
            }
        }
        
        function updateWelcomeMessage() {
            if (adminEmail) {
                const emailParts = adminEmail.split('@');
                if (emailParts.length > 0) {
                    const name = emailParts[0].split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
                    adminWelcomeName.textContent = name;
                }
            }
        }
          async function loadRoleBasedStats() {
            let stats = [];
            
            // Fetch stats from backend
            const dashboardStats = await fetchDashboardStats();
            
            // Common stats for all roles
            stats.push({
                title: "Utilisateurs Actifs",
                value: "247",
                footer: "Derniers 30 jours",
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                color: "rgba(139, 92, 246, 0.1)",
                iconColor: "var(--primary-color)"
            });
            
            // Role-specific stats
            switch (adminRole) {
                case 'secretaire':
                    stats.push({
                        title: "Demandes de Profil",
                        value: dashboardStats.profileRequests.total.toString(),
                        footer: `${dashboardStats.profileRequests.pending} en attente`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
                        color: "rgba(245, 158, 11, 0.1)",
                        iconColor: "var(--warning-color)"
                    });
                    stats.push({
                        title: "Enseignants",
                        value: dashboardStats.enseignants.total.toString(),
                        footer: `${dashboardStats.enseignants.recent} nouveaux ce mois`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-award"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>',
                        color: "rgba(16, 185, 129, 0.1)",
                        iconColor: "var(--success-color)"
                    });
                    break;
                
                case 'chef-de-specialite':
                case 'chef-de-departement':
                    stats.push({
                        title: "Sections",
                        value: dashboardStats.sections.total.toString(),
                        footer: `${dashboardStats.sections.full} sections complètes`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
                        color: "rgba(245, 158, 11, 0.1)",
                        iconColor: "var(--warning-color)"
                    });
                    stats.push({
                        title: "Demandes de Changement",
                        value: dashboardStats.changeRequests.total.toString(),
                        footer: `${dashboardStats.changeRequests.pending} en attente`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                        color: "rgba(16, 185, 129, 0.1)",
                        iconColor: "var(--success-color)"
                    });
                    stats.push({
                        title: "Enseignants",
                        value: dashboardStats.enseignants.total.toString(),
                        footer: `${dashboardStats.enseignants.recent} nouveaux ce mois`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-award"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>',
                        color: "rgba(239, 68, 68, 0.1)",
                        iconColor: "var(--danger-color)"
                    });
                    break;
                  case 'vice-doyen':
                case 'doyen':
                    stats.push({
                        title: "Sections",
                        value: dashboardStats.sections.total.toString(),
                        footer: "Toutes spécialités",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
                        color: "rgba(245, 158, 11, 0.1)",
                        iconColor: "var(--warning-color)"
                    });
                    stats.push({
                        title: "Demandes de Changement",
                        value: dashboardStats.changeRequests.total.toString(),
                        footer: `${dashboardStats.changeRequests.pending} en attente`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                        color: "rgba(16, 185, 129, 0.1)",
                        iconColor: "var(--success-color)"
                    });
                    stats.push({
                        title: "Demandes de Profil",
                        value: dashboardStats.profileRequests.total.toString(),
                        footer: `${dashboardStats.profileRequests.pending} en attente`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
                        color: "rgba(239, 68, 68, 0.1)",
                        iconColor: "var(--danger-color)"
                    });
                    stats.push({
                        title: "Enseignants",
                        value: dashboardStats.enseignants.total.toString(),
                        footer: `${dashboardStats.enseignants.recent} nouveaux ce mois`,
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-award"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>',
                        color: "rgba(59, 130, 246, 0.1)",
                        iconColor: "#3B82F6"
                    });
                    break;
            }
            
            // Render stats
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: ${stat.color}; color: ${stat.iconColor}">
                            ${stat.icon}
                        </div>
                        <div class="stat-title">${stat.title}</div>
                    </div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-footer">${stat.footer}</div>
                </div>
            `).join('');
        }
        
        function loadAccessCards() {
            let cards = [];
            
            // Define access cards based on role permissions
            const rolePermissions = {
                'secretaire': [
                    {
                        title: "Gestion des Enseignants",
                        description: "Ajouter, modifier ou supprimer des enseignants",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                        link: 'admin-gestion-enseignants.html'
                    },
                    {
                        title: "Demandes de Profil",
                        description: "Gérer les demandes de modification de profil",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
                        link: 'admin-profile-requests.html'
                    }
                ],
                'chef-de-specialite': [
                    {
                        title: "Gestion des Sections",
                        description: "Gérer les sections et leur capacité",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
                        link: 'admin-gestion-sections.html'
                    },
                    {
                        title: "Demandes de Changement",
                        description: "Gérer les demandes de changement de section",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                        link: 'admin-demandes-section.html'
                    },
                    {
                        title: "Gestion des Enseignants",
                        description: "Gérer les enseignants de votre spécialité",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                        link: 'admin-gestion-enseignants.html'
                    }
                ],
                'chef-de-departement': [
                    {
                        title: "Gestion des Sections",
                        description: "Gérer les sections de votre département",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
                        link: 'admin-gestion-sections.html'
                    },
                    {
                        title: "Demandes de Changement",
                        description: "Gérer les demandes de changement de section",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                        link: 'admin-demandes-section.html'
                    },
                    {
                        title: "Gestion des Enseignants",
                        description: "Gérer les enseignants de votre département",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                        link: 'admin-gestion-enseignants.html'
                    }
                ],
                'vice-doyen': [
                    {
                        title: "Gestion des Sections",
                        description: "Superviser toutes les sections de la faculté",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
                        link: 'admin-gestion-sections.html'
                    },
                    {
                        title: "Demandes de Changement",
                        description: "Superviser les demandes de changement de section",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                        link: 'admin-demandes-section.html'
                    },
                    {
                        title: "Demandes de Profil",
                        description: "Gérer les demandes de modification de profil",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
                        link: 'admin-profile-requests.html'
                    },
                    {
                        title: "Gestion des Enseignants",
                        description: "Gérer tous les enseignants de la faculté",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                        link: 'admin-gestion-enseignants.html'
                    }
                ],
                'doyen': [
                    {
                        title: "Gestion des Sections",
                        description: "Superviser toutes les sections de la faculté",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
                        link: 'admin-gestion-sections.html'
                    },
                    {
                        title: "Demandes de Changement",
                        description: "Superviser les demandes de changement de section",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                        link: 'admin-demandes-section.html'
                    },
                    {
                        title: "Demandes de Profil",
                        description: "Gérer les demandes de modification de profil",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
                        link: 'admin-profile-requests.html'
                    },
                    {
                        title: "Gestion des Enseignants",
                        description: "Gérer tous les enseignants de la faculté",
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
                        link: 'admin-gestion-enseignants.html'
                    }
                ]
            };
            
            // Get cards for current role
            cards = rolePermissions[adminRole] || [];
            
            // Render access cards
            accessCards.innerHTML = cards.map(card => `
                <div class="access-card" onclick="window.location.href='${card.link}'">
                    <div class="access-card-header">
                        ${card.icon}
                    </div>
                    <div class="access-card-body">
                        <div class="access-card-title">${card.title}</div>
                        <div class="access-card-description">${card.description}</div>
                        <div class="access-card-footer">
                            Accéder
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadRecentActivity() {
            try {
                // In a real app, this would fetch from the API
                // Simulating activity data for now
                setTimeout(() => {
                    const activities = [
                        {
                            text: "Demande de changement de section approuvée pour Ahmed Benali",
                            time: "Il y a 30 minutes",
                            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
                            color: "rgba(16, 185, 129, 0.1)",
                            iconColor: "var(--success-color)"
                        },
                        {
                            text: "Nouvel enseignant ajouté: Dr. Karim Merabti",
                            time: "Il y a 2 heures",
                            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>',
                            color: "rgba(139, 92, 246, 0.1)",
                            iconColor: "var(--primary-color)"
                        },
                        {
                            text: "Demande de modification de profil rejetée pour Leila Khodja",
                            time: "Il y a 3 heures",
                            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                            color: "rgba(239, 68, 68, 0.1)",
                            iconColor: "var(--danger-color)"
                        },
                        {
                            text: "Capacité de la section L2-INFO-3 modifiée à 35 étudiants",
                            time: "Il y a 5 heures",
                            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>',
                            color: "rgba(245, 158, 11, 0.1)",
                            iconColor: "var(--warning-color)"
                        },
                        {
                            text: "Nouvel utilisateur administrateur connecté: samir.meziane@univ.dz",
                            time: "Il y a 1 jour",
                            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>',
                            color: "rgba(59, 130, 246, 0.1)",
                            iconColor: "#3B82F6"
                        }
                    ];
                    
                    // Filter activities based on role if needed
                    let relevantActivities = activities;
                    
                    // Render activities
                    activityList.innerHTML = relevantActivities.map(activity => `
                        <li class="activity-item">
                            <div class="activity-icon" style="background-color: ${activity.color}; color: ${activity.iconColor}">
                                ${activity.icon}
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${activity.text}</div>
                                <div class="activity-time">${activity.time}</div>
                            </div>
                        </li>
                    `).join('');
                }, 1000);
            } catch (error) {
                console.error('Error loading activities:', error);
                activityList.innerHTML = `<li class="activity-item" style="justify-content: center; padding: 20px;"><span>Impossible de charger les activités récentes</span></li>`;
            }
        }
        
        function showMessage(message, type = 'info') {
            if (type === 'clear') {
                statusMessage.style.display = 'none';
                return;
            }
            
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            
            switch (type) {
                case 'success':
                    statusMessage.classList.add('success');
                    break;
                case 'error':
                    statusMessage.classList.add('error');
                    break;
                case 'warning':
                    statusMessage.classList.add('warning');
                    break;
                default:
                    statusMessage.classList.add('info');
            }
            
            statusMessage.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Function to fetch dashboard statistics from the backend
        async function fetchDashboardStats() {
            try {
                // Profile request stats
                const profileRequestsPromise = fetch(`${API_BASE_URL}/profile-requests`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                }).then(res => res.ok ? res.json() : []);
                
                // Section stats 
                const sectionsPromise = fetch(`${API_BASE_URL}/sections`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                }).then(res => res.ok ? res.json() : []);
                
                // Change request stats
                const changeRequestsPromise = fetch(`${API_BASE_URL}/change-requests`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                }).then(res => res.ok ? res.json() : []);
                
                // Enseignant stats
                const enseignantsPromise = fetch(`${API_BASE_URL}/enseignants`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                }).then(res => res.ok ? res.json() : []);
                
                // Wait for all promises to resolve
                const [profileRequests, sections, changeRequests, enseignants] = 
                    await Promise.all([profileRequestsPromise, sectionsPromise, changeRequestsPromise, enseignantsPromise]);
                
                // Calculate stats
                return {
                    profileRequests: {
                        total: profileRequests.length,
                        pending: profileRequests.filter(r => r.status === 'pending').length
                    },
                    sections: {
                        total: sections.length,
                        full: sections.filter(s => s.etudiantsCount >= s.capacite).length
                    },
                    changeRequests: {
                        total: changeRequests.length,
                        pending: changeRequests.filter(r => r.status === 'pending').length
                    },
                    enseignants: {
                        total: enseignants.length,
                        recent: enseignants.filter(e => {
                            const createdDate = new Date(e.createdAt);
                            const oneMonthAgo = new Date();
                            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                            return createdDate > oneMonthAgo;
                        }).length
                    }
                };
            } catch (error) {
                console.error('Error fetching dashboard stats:', error);
                return {
                    profileRequests: { total: 0, pending: 0 },
                    sections: { total: 0, full: 0 },
                    changeRequests: { total: 0, pending: 0 },
                    enseignants: { total: 0, recent: 0 }
                };
            }
        }
    </script>
</body>
</html>
