<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Enseignants - Administration</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Sora:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link href="style/admin.css" rel="stylesheet" />
    <link href="style/section-statistics.css" rel="stylesheet" />
    <!-- Add reference to admin auth helper -->
    <script src="js/admin-api-config.js"></script>
    <script src="js/admin-auth.js"></script>
    <script src="js/admin-logout.js"></script>
    <script src="js/admin-pages-validation.js"></script>
    <script src="js/admin-mocks.js"></script>
    <script src="js/admin-api-utils.js"></script>
    <script src="js/admin-api-fetchers.js"></script>
    <script src="js/admin-api-loader.js"></script>
    <script src="js/admin-section-utils.js"></script>
    <script src="js/section-statistics.js"></script>
    <script src="js/teacher-table-renderer.js"></script>
    <script src="js/admin-enseignants.js"></script>
    <!-- Chart.js for statistics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .teacher-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 10px;
        text-transform: uppercase;
      } /* Specialty-specific avatar colors removed as requested */

      .teacher-info {
        display: flex;
        align-items: center;
      }

      .teacher-details span {
        display: block;
      }

      .teacher-name {
        font-weight: 600;
      }

      .teacher-email {
        color: var(--gray-color);
        font-size: 0.8rem;
      } /* specialty-badge class removed as requested */
      .section-count-badge {
        background-color: #4caf50;
        color: white;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        width: 18px;
        height: 18px;
        margin-left: 8px;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .section-count-badge.empty {
        background-color: #e0e0e0;
        color: #757575;
        opacity: 0.7;
      }

      tr:hover .section-count-badge.empty {
        background-color: #bdbdbd;
        color: #424242;
      }

      .teacher-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 0.8rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
      }

      .btn-info {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-info:hover {
        background-color: #7c4dff;
        transform: translateY(-1px);
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c82333;
        transform: translateY(-1px);
      }

      .status-message.error {
        background-color: #ffebee;
        color: #c62828;
        border-left: 4px solid #c62828;
      }

      .status-message.success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid #2e7d32;
      }

      .status-message.warning {
        background-color: #fff3e0;
        color: #e65100;
        border-left: 4px solid #ff9800;
      }

      .status-message {
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-weight: 500;
        animation: fadeIn 0.3s ease-in-out;
      }
      /* Form improvements */
      .form-group {
        margin-bottom: 16px;
        position: relative;
      }

      .form-input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 6px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .form-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.15);
        outline: none;
      }

      .form-input.error {
        border-color: #dc3545;
        background-color: #fff8f8;
      }

      .form-input.success {
        border-color: #4caf50;
        background-color: #f8fff8;
      }

      .form-input::placeholder {
        color: #aaa;
        opacity: 0.7;
      }

      .form-input:focus::placeholder {
        opacity: 0.5;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }
      .form-help {
        display: block;
        margin-top: 5px;
        font-size: 0.8rem;
        color: var(--gray-color);
        padding-left: 2px;
        transition: color 0.2s;
      }

      .form-input:focus + .form-help,
      .form-input:hover + .form-help {
        color: var(--primary-color);
      }

      .form-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 24px;
        gap: 12px;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 24px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 120px;
      }

      .btn-primary:hover {
        background-color: #7c4dff;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(124, 77, 255, 0.2);
      }

      .btn-cancel {
        background-color: #f5f5f5;
        color: #666;
        padding: 10px 24px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-cancel:hover {
        background-color: #e9e9e9;
      }

      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .toggle-password-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        opacity: 0.6;
        transition: opacity 0.2s;
      }

      .toggle-password-btn:hover {
        opacity: 1;
      }

      .required {
        color: #dc3545;
      }

      /* Animation for status messages */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .teacher-form {
          grid-template-columns: 1fr;
        }

        .action-buttons {
          flex-direction: column;
        }
      }

      /* Loading spinner styles */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 6px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .optional {
        color: #666;
        font-weight: normal;
        font-style: italic;
      }

      .modal-content {
        position: relative;
        overflow: visible;
      }

      .error-text {
        color: #dc3545 !important;
      }

      .success-text {
        color: #4caf50 !important;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar - will be loaded via JavaScript -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">Gestion des Enseignants</h1>
          <div class="header-actions">
            <button class="header-btn" id="add-teacher-btn">
              <svg
                class="header-btn-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path d="M12 5v14M5 12h14"></path>
              </svg>
              Ajouter un enseignant
            </button>
          </div>
        </div>

        <div class="content-container">
          <!-- Status Messages -->
          <div
            id="status-message"
            class="status-message"
            style="display: none"
          ></div>

          <!-- Summary Cards -->
          <div class="cards-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Total des enseignants</div>
                <div class="stat-card-icon icon-purple">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                </div>
              </div>
              <div class="stat-card-value" id="total-teachers">--</div>
              <div class="stat-card-description">Enseignants enregistr√©s</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Sections affect√©es</div>
                <div class="stat-card-icon icon-blue">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path
                      d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
                    ></path>
                  </svg>
                </div>
              </div>
              <div class="stat-card-value" id="total-sections">--</div>
              <div class="stat-card-description">Sections avec enseignants</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="filters">
            <div class="filter-group">
              <label for="id-filter">Matricule:</label>
              <select id="id-filter" class="filter-select">
                <option value="all">Tous</option>
                <option value="defined">Avec Matricule</option>
                <option value="undefined">Sans Matricule</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="section-filter">Sections:</label>
              <select id="section-filter" class="filter-select">
                <option value="all">Tous</option>
                <option value="assigned">Avec sections</option>
                <option value="unassigned">Sans section</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="search">Recherche:</label>
              <input
                type="text"
                id="search"
                class="filter-input"
                placeholder="Nom, email..."
              />
            </div>
          </div>

          <!-- Teachers Table -->
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Enseignant</th>
                  <th>Matricule</th>
                  <th>Contact</th>
                  <th>Date d'ajout</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="teachers-table-body">
                <tr class="loading-row">
                  <td colspan="6">Chargement des enseignants...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination" id="pagination">
            <!-- Pagination will be added here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Teacher Modal -->
    <div id="teacher-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modal-title">Ajouter un enseignant</h2>
        <form id="teacher-form" class="form teacher-form">
          <input type="hidden" id="teacher-id" />

          <div class="form-group">
            <label for="teacher-firstName"
              >Pr√©nom: <span class="required">*</span></label
            >
            <input
              type="text"
              id="teacher-firstName"
              class="form-input"
              required
              autocomplete="given-name"
              placeholder="Pr√©nom de l'enseignant"
            />
          </div>

          <div class="form-group">
            <label for="teacher-lastName"
              >Nom: <span class="required">*</span></label
            >
            <input
              type="text"
              id="teacher-lastName"
              class="form-input"
              required
              autocomplete="family-name"
              placeholder="Nom de l'enseignant"
            />
          </div>

          <div class="form-group">
            <label for="teacher-email"
              >Email: <span class="required">*</span></label
            >
            <input
              type="email"
              id="teacher-email"
              class="form-input"
              required
              autocomplete="email"
              placeholder="example@university.edu"
            />
            <small class="form-help"
              >Cet email servira de login pour l'enseignant</small
            >
          </div>

          <!-- ID Enseignant: only show in edit mode, read-only -->
          <div class="form-group" id="teacher-id-group" style="display: none">
            <label for="teacher-id-number">ID:</label>
            <input
              type="text"
              id="teacher-id-number"
              class="form-input"
              readonly
            />
            <small class="form-help"
              >Identifiant unique g√©n√©r√© automatiquement</small
            >
          </div>

          <div class="form-group">
            <label for="teacher-matricule">Matricule:</label>
            <input
              type="text"
              id="teacher-matricule"
              class="form-input"
              placeholder="Matricule de l'enseignant"
              maxlength="20"
            />
            <small class="form-help"
              >Identifiant unique attribu√© √† l'enseignant</small
            >
          </div>

          <div class="form-group">
            <label for="teacher-password">
              <span id="password-label-text"
                >Mot de passe: <span class="required">*</span></span
              >
            </label>
            <div class="password-container">
              <input type="password" id="teacher-password" class="form-input" />
              <button
                type="button"
                class="toggle-password-btn"
                id="toggle-password"
              >
                üëÅÔ∏è
              </button>
            </div>
            <small class="form-help" id="password-help"
              >Minimum 6 caract√®res</small
            >
          </div>

          <div class="form-buttons">
            <button type="button" class="btn btn-cancel" id="cancel-btn">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" id="save-btn">
              Enregistrer
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirm-delete-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Confirmation de suppression</h2>
        <p>
          √ätes-vous s√ªr de vouloir supprimer cet enseignant? Cette action est
          irr√©versible.
        </p>
        <div style="display: flex; gap: 1rem; margin-top: 1rem">
          <button
            class="header-btn"
            style="background-color: var(--gray-color)"
            id="cancel-delete-btn"
          >
            Annuler
          </button>
          <button
            class="header-btn"
            style="background-color: var(--danger-color)"
            id="confirm-delete-btn"
          >
            Supprimer
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize global variables
      let allTeachers = [];
      let filteredTeachers = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let authToken =
        localStorage.getItem("admin_token") ||
        sessionStorage.getItem("admin_token");
      let teacherToDelete = null; // Track the ID of teacher to delete

      // DOM Elements
      const statusMessage = document.getElementById("status-message");
      const teachersTableBody = document.getElementById("teachers-table-body");
      const paginationElement = document.getElementById("pagination");
      const searchInput = document.getElementById("search");
      const totalTeachersEl = document.getElementById("total-teachers");
      const totalSectionsEl = document.getElementById("total-sections");
      const recentActivitiesEl = document.getElementById("recent-activities");

      // Modal elements
      const teacherModal = document.getElementById("teacher-modal");
      const modalTitle = document.getElementById("modal-title");
      const teacherForm = document.getElementById("teacher-form");
      const teacherIdInput = document.getElementById("teacher-id");
      const teacherFirstNameInput =
        document.getElementById("teacher-firstName");
      const teacherLastNameInput = document.getElementById("teacher-lastName");
      const teacherEmailInput = document.getElementById("teacher-email");
      const teacherIdNumberInput = document.getElementById("teacher-id-number");

      const teacherPasswordInput = document.getElementById("teacher-password");
      const saveBtn = document.getElementById("save-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const closeModalBtn = document.querySelector(".close-modal"); // Helper to show status messages with improved formatting
      function showMessage(message, type = "info") {
        if (!statusMessage) return;

        // Allow HTML content when needed
        if (
          typeof message === "string" &&
          (message.includes("<br>") || message.includes("<"))
        ) {
          statusMessage.innerHTML = message;
        } else {
          statusMessage.textContent = message;
        }

        // Apply appropriate styling
        statusMessage.className = `status-message ${type}`;
        statusMessage.style.display = "block";

        // Scroll to the message for visibility
        statusMessage.scrollIntoView({ behavior: "smooth", block: "start" });

        // Auto-hide after a delay, longer for errors
        const timeout = type === "error" ? 8000 : 5000;
        setTimeout(() => {
          statusMessage.style.display = "none";
        }, timeout);
      }

      // Wrapper functions for teacher CRUD operations
      async function updateTeacherAPI(teacherId, teacherData) {
        try {
          // Use PUT to /api/enseignants/:id
          const response = await apiCall(
            `enseignants/${teacherId}`,
            "PUT",
            teacherData
          );
          if (response && response.success) {
            return { success: true, data: response.data };
          } else {
            return {
              success: false,
              message: response.error || "Erreur lors de la mise √† jour.",
            };
          }
        } catch (error) {
          return { success: false, message: error.message };
        }
      }
      async function createTeacherAPI(teacherData) {
        try {
          // Use POST to /api/enseignants
          const response = await apiCall("enseignants", "POST", teacherData);
          if (response && response.success) {
            return { success: true, data: response.data };
          } else {
            return {
              success: false,
              message: response.error || "Erreur lors de l'ajout.",
            };
          }
        } catch (error) {
          return { success: false, message: error.message };
        }
      }
      async function deleteTeacherAPI(teacherId) {
        try {
          // Use DELETE to /api/enseignants/:id
          const response = await apiCall(`enseignants/${teacherId}`, "DELETE");
          if (response && response.success) {
            return { success: true };
          } else {
            return {
              success: false,
              message: response.error || "Erreur lors de la suppression.",
            };
          }
        } catch (error) {
          return { success: false, message: error.message };
        }
      }
      /**
       * Count how many teachers have sections assigned
       * @returns {Promise<{count: number, teachersWithSections: Set<string|number>}>} Statistics about teachers with sections
       */
      async function countTeachersWithSections() {
        try {
          // Get all sections
          const sections = await getSections();

          if (!sections || !sections.length) {
            return { count: 0, teachersWithSections: new Set() };
          }

          // Create an array to store all teacher-section mappings
          let allSectionResponsables = [];

          // Get responsables for each section
          for (const section of sections) {
            try {
              const response = await fetch(
                `https://unicersityback-production-1fbe.up.railway.app/api/sections/${section.id}/responsables`,
                {
                  headers: {
                    Authorization: `Bearer ${
                      localStorage.getItem("admin_token") ||
                      sessionStorage.getItem("admin_token")
                    }`,
                  },
                }
              );

              if (response.ok) {
                const sectionResponsables = await response.json();
                if (Array.isArray(sectionResponsables)) {
                  // Add section info to each responsable for display
                  const enrichedResponsables = sectionResponsables.map(
                    (resp) => ({
                      ...resp,
                      section: {
                        id: section.id,
                        name: section.name,
                        code: section.code,
                      },
                    })
                  );

                  allSectionResponsables = [
                    ...allSectionResponsables,
                    ...enrichedResponsables,
                  ];
                }
              }
            } catch (err) {
              console.warn(
                `Error getting responsables for section ${section.id}:`,
                err
              );
            }
          }

          // Count unique teachers with sections
          const teachersWithSections = new Set();
          const teacherSectionCounts = {};

          // Process all responsables
          allSectionResponsables.forEach((resp) => {
            const teacherId =
              resp.enseignantId || (resp.enseignant && resp.enseignant.id);
            if (teacherId) {
              teachersWithSections.add(teacherId);
              teacherSectionCounts[teacherId] =
                (teacherSectionCounts[teacherId] || 0) + 1;
            }
          });

          // Update section count for each teacher
          allTeachers.forEach((teacher) => {
            if (teacher && teacher.id) {
              teacher.sectionCount = teacherSectionCounts[teacher.id] || 0;
            }
          });

          return {
            count: teachersWithSections.size,
            teachersWithSections,
          };
        } catch (error) {
          console.error("Error counting teachers with sections:", error);
          return { count: 0, teachersWithSections: new Set() };
        }
      }
      /**
       * Generate a teacher ID
       * @param {Object} options - Additional options
       * @param {object} options - Additional options
       * @returns {string} Generated teacher ID
       */
      function generateTeacherId(options = {}) {
        // Use a standard department code for all teachers
        const deptCode = "UNI";

        // Get current year (or use provided year)
        const currentYear = options.year || new Date().getFullYear();

        // Get sequential number (or generate random one)
        const sequentialNum = options.sequential
          ? String(options.sequential).padStart(4, "0")
          : Math.floor(1000 + Math.random() * 9000);

        // Format: DEPxxx-YYYY-NNNN
        return `${deptCode}-${currentYear}-${sequentialNum}`;
      }
      /**
       * Calculate the next sequential number for teacher IDs
       * @returns {number} Next sequential number
       */
      function calculateNextSequentialNumber() {
        if (!Array.isArray(allTeachers)) return 1001;

        // Use a standard department code
        const deptCode = "UNI";
        const currentYear = new Date().getFullYear();

        // Find teachers with existing IDs and extract their ID numbers
        const regex = new RegExp(`^${deptCode}-${currentYear}-(\\d{4})$`);
        const existingNumbers = [];

        allTeachers.forEach((teacher) => {
          if (teacher.id) {
            const match = teacher.id.match(regex);
            if (match && match[1]) {
              existingNumbers.push(parseInt(match[1], 10));
            }
          }
        });

        // If no existing numbers, start with 1001
        if (existingNumbers.length === 0) {
          return 1001;
        }

        // Otherwise, find the maximum and add 1
        return Math.max(...existingNumbers) + 1;
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Verify authentication using the admin-auth.js helper
          const isAuthenticated = await verifyAdminToken();
          if (!isAuthenticated) {
            window.location.href = "admin-login.html";
            return;
          }

          // Load the sidebar
          await loadSidebar(); // Load teachers data
          await loadTeachers();

          // Setup event listeners
          setupEventListeners();

          // Initial stats calculation (async)
          await updateStats();
        } catch (error) {
          console.error("Initialization error:", error);
          showMessage(
            "Une erreur est survenue lors de l'initialisation de la page.",
            "error"
          );
        }
      });
      async function loadSidebar() {
        try {
          // Get role from storage
          const role =
            localStorage.getItem("admin_role") ||
            sessionStorage.getItem("admin_role");

          console.log("Loading sidebar for role:", role);

          // Map roles to sidebar files
          const sidebarFiles = {
            doyen: "admin-sidebar-doyen.html",
            "vice-doyen": "admin-sidebar-vice-doyen.html",
            "chef-de-departement": "admin-sidebar-chef-departement.html",
            "chef-de-specialite": "admin-sidebar-chef-specialite.html",
            secretaire: "admin-sidebar-secretaire.html",
          };

          // Get the sidebar file for the role
          const sidebarFile = sidebarFiles[role] || sidebarFiles["doyen"]; // Default to doyen

          console.log("Loading sidebar file:", sidebarFile);

          // Load the sidebar HTML
          const response = await fetch(sidebarFile);
          const html = await response.text();

          // Insert the sidebar HTML into the container
          document.getElementById("sidebar-container").innerHTML = html;

          // Set up logout button event listener
          const logoutBtn = document.getElementById("logout-btn");
          if (logoutBtn && typeof handleAdminLogout === "function") {
            logoutBtn.addEventListener("click", handleAdminLogout);
          }

          // Update admin info manually since scripts in innerHTML don't execute
          updateSidebarAdminInfo();

          // Set active menu item
          setSidebarActiveMenuItem();

          console.log("‚úÖ Sidebar loaded successfully for role:", role);
        } catch (error) {
          console.error("Error loading sidebar:", error);
          showMessage("Impossible de charger la barre lat√©rale.", "error");
        }
      }

      async function loadTeachers() {
        if (!teachersTableBody) {
          console.error("teachersTableBody element not found.");
          if (statusMessage)
            statusMessage.textContent =
              "Erreur: Table des enseignants non trouv√©e.";
          return;
        }
        teachersTableBody.innerHTML =
          '<tr><td colspan="7" class="loading">Chargement des enseignants...</td></tr>'; // Assuming 7 columns
        let data = {};
        try {
          data = await fetchTeachersAPI();
        } catch (error) {
          data = {};
        }
        allTeachers = Array.isArray(data.teachers)
          ? data.teachers
          : Array.isArray(data)
          ? data
          : [];
        filteredTeachers = [...allTeachers];
        if (allTeachers.length === 0) {
          teachersTableBody.innerHTML =
            '<tr><td colspan="7" class="no-data">Aucun enseignant trouv√©.</td></tr>';
        } else {
          renderTable();
        }
        updateStats();
        populateFilters(); // Initialize filters
      }
      function setupEventListeners() {
        const idFilter = document.getElementById("id-filter");
        if (idFilter) idFilter.addEventListener("change", filterAndRender);

        const sectionFilter = document.getElementById("section-filter");
        if (sectionFilter)
          sectionFilter.addEventListener("change", filterAndRender);

        if (searchInput) searchInput.addEventListener("input", filterAndRender);

        const addTeacherBtn = document.getElementById("add-teacher-btn");
        if (addTeacherBtn)
          addTeacherBtn.addEventListener("click", () => openTeacherModal());

        document
          .querySelectorAll(".close-modal")
          .forEach((el) => el.addEventListener("click", closeAllModals));

        const cancelBtn = document.getElementById("cancel-btn");
        if (cancelBtn) cancelBtn.addEventListener("click", closeAllModals);
        const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
        if (cancelDeleteBtn)
          cancelDeleteBtn.addEventListener("click", closeAllModals);

        const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
        if (confirmDeleteBtn)
          confirmDeleteBtn.addEventListener("click", confirmDeleteTeacher);

        const teacherForm = document.getElementById("teacher-form");
        if (teacherForm)
          teacherForm.addEventListener("submit", handleFormSubmit);

        const togglePasswordBtn = document.getElementById("toggle-password");
        if (togglePasswordBtn)
          togglePasswordBtn.addEventListener("click", togglePasswordVisibility);

        // Add event listeners to modify buttons (will be added after table renders)
        teachersTableBody.addEventListener("click", (e) => {
          if (e.target.classList.contains("btn-info")) {
            const teacherId = e.target.getAttribute("data-id");
            if (teacherId) openTeacherModal(teacherId);
          }
        });
      }
      function populateFilters() {
        // All filters are now handled elsewhere
      }
      function filterAndRender() {
        if (!allTeachers || !Array.isArray(allTeachers)) {
          teachersTableBody.innerHTML =
            '<tr><td colspan="6" class="no-data">Donn√©es enseignants indisponibles.</td></tr>';
          return;
        }
        const idFilterValue = document.getElementById("id-filter").value;
        const sectionFilterValue =
          document.getElementById("section-filter").value;
        const searchValue = searchInput ? searchInput.value.toLowerCase() : "";

        // Reset to page 1 when filters change
        currentPage = 1;

        filteredTeachers = allTeachers.filter((teacher) => {
          // Matricule filter
          if (
            idFilterValue === "defined" &&
            (!teacher.matricule || teacher.matricule === "")
          ) {
            return false;
          }
          if (
            idFilterValue === "undefined" &&
            teacher.matricule &&
            teacher.matricule !== ""
          ) {
            return false;
          }

          // Section filter
          if (
            sectionFilterValue === "assigned" &&
            (!teacher.sectionCount || teacher.sectionCount === 0)
          ) {
            return false;
          }
          if (
            sectionFilterValue === "unassigned" &&
            teacher.sectionCount &&
            teacher.sectionCount > 0
          ) {
            return false;
          } // Search filter (multiple fields)
          if (searchValue) {
            const teacherFullName = `${teacher.firstName || ""} ${
              teacher.lastName || ""
            }`.toLowerCase();
            const email = (teacher.email || "").toLowerCase();
            const id = (teacher.id || "").toLowerCase();
            const matricule = (teacher.matricule || "").toLowerCase();

            return (
              teacherFullName.includes(searchValue) ||
              email.includes(searchValue) ||
              id.includes(searchValue) ||
              matricule.includes(searchValue)
            );
          }

          return true;
        });

        renderTable();
      }

      function renderTable() {
        if (!teachersTableBody) return;
        teachersTableBody.innerHTML = "";

        if (filteredTeachers.length === 0) {
          teachersTableBody.innerHTML =
            '<tr><td colspan="7" class="no-data">Aucun enseignant ne correspond aux filtres.</td></tr>';
          updatePagination();
          return;
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedTeachers = filteredTeachers.slice(startIndex, endIndex);

        paginatedTeachers.forEach((teacher) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="teacher-info">
                <img src="${
                  teacher.avatarUrl ||
                  teacher.avatar ||
                  `https://ui-avatars.com/api/?name=${encodeURIComponent(
                    (teacher.firstName || "") + " " + (teacher.lastName || "")
                  )}&background=8b5cf6&color=fff&size=40`
                }" alt="Avatar" class="teacher-avatar">
                <div class="teacher-details">
                  <span class="teacher-name">${teacher.firstName || ""} ${
            teacher.lastName || "N/A"
          }</span>
                  <span class="teacher-email">${teacher.email || "N/A"}</span>
                </div>
              </div>
            </td>
            <td>${teacher.matricule || "Non d√©fini"}</td>
            <td>${teacher.email || "N/A"}</td>
            <td>${new Date(
              teacher.createdAt || teacher.dateCreated || Date.now()
            ).toLocaleDateString()}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-info btn-sm" data-id="${
                  teacher.id
                }">Modifier</button>
                <button class="btn btn-danger btn-sm" onclick="openConfirmDeleteModal('${
                  teacher.id
                }')">Supprimer</button>
              </div>
            </td>
          `;
          teachersTableBody.appendChild(row);
        });
        updatePagination();
      }

      function updatePagination() {
        if (!paginationElement) return;
        paginationElement.innerHTML = "";
        const totalPages = Math.ceil(filteredTeachers.length / itemsPerPage);

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const button = document.createElement("button");
          button.textContent = i;
          button.classList.add("pagination-btn");
          if (i === currentPage) button.classList.add("active");
          button.addEventListener("click", () => {
            currentPage = i;
            renderTable();
          });
          paginationElement.appendChild(button);
        }
      }
      /**
       * Update statistics on the page
       */
      async function updateStats() {
        // Update total teachers counter
        if (totalTeachersEl) {
          totalTeachersEl.textContent = allTeachers.length;
        }

        // Update sections with teachers counter
        if (totalSectionsEl) {
          totalSectionsEl.textContent = "...";
          try {
            const result = await countTeachersWithSections();
            totalSectionsEl.textContent = result.count;
          } catch (error) {
            console.error("Error updating section stats:", error);
            totalSectionsEl.textContent = "--";
          }
        }

        // Recent activities section has been removed as requested
      }
      function openTeacherModal(teacherId) {
        if (!teacherModal || !teacherForm) return;

        // Reset form and clear previous values
        teacherForm.reset();
        teacherIdInput.value = ""; // Hidden input for ID

        // Hide ID field initially
        const teacherIdGroup = document.getElementById("teacher-id-group");
        if (teacherIdGroup) teacherIdGroup.style.display = "none";

        // Get password elements
        const passwordLabel = document.getElementById("password-label-text");
        const passwordHelp = document.getElementById("password-help");
        const togglePasswordBtn = document.getElementById("toggle-password");
        const passwordInput = document.getElementById("teacher-password");

        if (teacherId) {
          // Edit mode
          modalTitle.textContent = "Modifier l'enseignant"; // Show loading state in modal
          const formFields = teacherForm.querySelectorAll("input, select");
          formFields.forEach((field) => (field.disabled = true));

          // Create a loading indicator without destroying the form
          const loadingIndicator = document.createElement("div");
          loadingIndicator.id = "loading-indicator";
          loadingIndicator.className = "loading-overlay";
          loadingIndicator.innerHTML = `
            <div class="loading-spinner"></div>
            <p>Chargement des donn√©es...</p>
          `;
          teacherForm.appendChild(loadingIndicator);

          // Find the teacher by ID
          const teacher = allTeachers.find((t) => t.id == teacherId);

          if (teacher) {
            // Remove loading indicator
            const loadingIndicator =
              document.getElementById("loading-indicator");
            if (loadingIndicator) loadingIndicator.remove();

            // Re-enable form fields
            formFields.forEach((field) => (field.disabled = false));

            // Fill form with teacher data
            teacherIdInput.value = teacher.id;
            teacherFirstNameInput.value = teacher.firstName || "";
            teacherLastNameInput.value = teacher.lastName || "";
            teacherEmailInput.value = teacher.email || "";

            // Populate matricule field
            const matriculeInput = document.getElementById("teacher-matricule");
            if (matriculeInput) matriculeInput.value = teacher.matricule || "";

            const idNumberInput = document.getElementById("teacher-id-number");
            if (idNumberInput) idNumberInput.value = teacher.id || "Non d√©fini"; // Show ID field in edit mode
            if (teacherIdGroup) teacherIdGroup.style.display = "block";

            // Password is optional in edit mode
            if (passwordInput) passwordInput.required = false;
            if (passwordLabel) {
              passwordLabel.innerHTML =
                "Mot de passe: <span class='optional'>(facultatif)</span>";
            }
            if (passwordHelp) {
              passwordHelp.innerHTML =
                "Laissez vide pour conserver le mot de passe actuel";
            }
          }
        } else {
          // Add mode
          modalTitle.textContent = "Ajouter un enseignant";

          // Password is required in add mode
          if (passwordInput) passwordInput.required = true;
          if (passwordLabel) {
            passwordLabel.innerHTML =
              "Mot de passe: <span class='required'>*</span>";
          }
          if (passwordHelp) {
            passwordHelp.innerHTML = "Minimum 6 caract√®res";
          }
        }

        // Show the modal
        teacherModal.style.display = "block";
      }

      function closeTeacherModal() {
        if (teacherModal) teacherModal.style.display = "none";
      }
      async function handleFormSubmit(event) {
        event.preventDefault();

        const teacherFirstNameInput =
          document.getElementById("teacher-firstName");
        const teacherLastNameInput =
          document.getElementById("teacher-lastName");
        const teacherEmailInput = document.getElementById("teacher-email");
        const teacherMatriculeInput =
          document.getElementById("teacher-matricule");
        const passwordInput = document.getElementById("teacher-password");
        const teacherIdInput = document.getElementById("teacher-id");

        if (
          !teacherFirstNameInput ||
          !teacherLastNameInput ||
          !teacherEmailInput
        ) {
          showMessage("Erreur: √âl√©ments de formulaire manquants", "error");
          return;
        }

        const isEdit = teacherIdInput && teacherIdInput.value;
        const teacherId = isEdit ? teacherIdInput.value : null;

        let teacherData = {};

        // Always include required fields for both create and update
        teacherData.firstName = teacherFirstNameInput.value.trim();
        teacherData.lastName = teacherLastNameInput.value.trim();

        if (isEdit) {
          // For edit mode, only include changed fields
          const currentTeacher =
            allTeachers.find((t) => t.id == teacherId) || {};

          if (teacherEmailInput.value !== currentTeacher.email) {
            teacherData.email = teacherEmailInput.value.trim();
          }

          if (
            teacherMatriculeInput &&
            teacherMatriculeInput.value !== currentTeacher.matricule
          ) {
            teacherData.matricule = teacherMatriculeInput.value.trim();
          }

          if (passwordInput.value.trim()) {
            teacherData.password = passwordInput.value;
          }
        } else {
          // For create mode, include all required fields
          teacherData.email = teacherEmailInput.value.trim();
          teacherData.password = passwordInput.value || "defaultpassword";

          if (teacherMatriculeInput && teacherMatriculeInput.value.trim()) {
            teacherData.matricule = teacherMatriculeInput.value.trim();
          }
        }

        try {
          let result;
          if (isEdit) {
            // Use PUT for updates
            result = await updateTeacherAPI(teacherId, teacherData);
          } else {
            // Use POST for creation
            result = await createTeacherAPI(teacherData);
          }

          showMessage(
            isEdit
              ? "Enseignant modifi√© avec succ√®s!"
              : "Enseignant ajout√© avec succ√®s!",
            "success"
          );
          closeAllModals();
          await loadTeachers();
        } catch (error) {
          console.error("Erreur lors de la soumission:", error);
          showMessage(error.message || "Une erreur est survenue", "error");
        }
      } // These functions are duplicates and have incorrect parameter order - removing them
      // The correct functions are defined above at line 678 with proper parameter order

      /**
       * Check if an email is already in use by another teacher
       * @param {string} email - The email to check
       * @param {string} currentTeacherId - The ID of the current teacher (for edit mode)
       * @returns {boolean} True if the email is unique or belongs to the current teacher
       */
      function isEmailUnique(email, currentTeacherId = null) {
        if (!Array.isArray(allTeachers)) return true;

        // Check if any teacher (other than the current one) has this email
        const existingTeacher = allTeachers.find(
          (teacher) =>
            teacher.email === email &&
            (!currentTeacherId || teacher.id != currentTeacherId)
        );

        return !existingTeacher;
      }

      /**
       * Validate email input as the user types
       * @param {HTMLInputElement} input - The email input element
       * @param {string} currentTeacherId - The ID of the current teacher (for edit mode)
       */
      function validateEmailInput(input, currentTeacherId = null) {
        const email = input.value.trim();
        const emailHelp = input.nextElementSibling;

        // Check basic email format
        const isValidFormat = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

        if (!email) {
          input.classList.remove("error", "success");
          if (emailHelp)
            emailHelp.textContent =
              "Cet email servira de login pour l'enseignant";
          return;
        }

        if (!isValidFormat) {
          input.classList.add("error");
          input.classList.remove("success");
          if (emailHelp) {
            emailHelp.textContent = "Format d'email invalide";
            emailHelp.classList.add("error-text");
          }
          return;
        }

        // Check if email is unique
        if (!isEmailUnique(email, currentTeacherId)) {
          input.classList.add("error");
          input.classList.remove("success");
          if (emailHelp) {
            emailHelp.textContent =
              "Cet email est d√©j√† utilis√© par un autre enseignant";
            emailHelp.classList.add("error-text");
          }
          return;
        }

        // Email is valid and unique
        input.classList.add("success");
        input.classList.remove("error");
        if (emailHelp) {
          emailHelp.textContent = "Email valide";
          emailHelp.classList.remove("error-text");
          emailHelp.classList.add("success-text");
        }
      }

      async function fetchTeachersAPI() {
        try {
          const teachers = await getTeachers();

          // Get all sections to count how many each teacher is assigned to
          const sections = await getSections();

          // Create a map of teacher IDs to their section counts
          const teacherSectionCounts = {};

          if (sections && sections.length > 0) {
            sections.forEach((section) => {
              if (section.responsables && Array.isArray(section.responsables)) {
                section.responsables.forEach((resp) => {
                  if (resp.enseignant && resp.enseignant.id) {
                    const teacherId = resp.enseignant.id;
                    teacherSectionCounts[teacherId] =
                      (teacherSectionCounts[teacherId] || 0) + 1;
                  }
                });
              }
            });
          }

          // Add the section count to each teacher
          if (Array.isArray(teachers)) {
            teachers.forEach((teacher) => {
              teacher.sectionCount = teacherSectionCounts[teacher.id] || 0;
            });
          }

          return teachers;
        } catch (error) {
          console.error("Error fetching teachers:", error);
          displayError("Erreur lors du chargement des enseignants.");
          return [];
        }
      }

      function closeAllModals() {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => {
          modal.style.display = "none";
        });
      }

      /**
       * Open the delete confirmation modal for a teacher
       * @param {string} teacherId - ID of the teacher to delete
       */
      function openConfirmDeleteModal(teacherId) {
        teacherToDelete = teacherId;
        const confirmModal = document.getElementById("confirm-delete-modal");
        if (confirmModal) confirmModal.style.display = "block";
      }

      /**
       * Handle the confirmation of teacher deletion
       */
      async function confirmDeleteTeacher() {
        if (!teacherToDelete) {
          showMessage(
            "Erreur: Aucun enseignant s√©lectionn√© pour la suppression",
            "error"
          );
          return;
        }

        try {
          const result = await deleteTeacherAPI(teacherToDelete);

          if (result.success) {
            showMessage("Enseignant supprim√© avec succ√®s", "success");
            // Refresh the teachers list
            await loadTeachers();
          } else {
            showMessage(
              result.message || "Erreur lors de la suppression",
              "error"
            );
          }
        } catch (error) {
          console.error("Erreur lors de la suppression:", error);
          showMessage(
            "Une erreur est survenue lors de la suppression",
            "error"
          );
        }

        // Reset the teacher to delete and close the modal
        teacherToDelete = null;
        closeAllModals();
      }

      /**
       * Toggle password visibility in form
       */
      function togglePasswordVisibility() {
        const passwordInput = document.getElementById("teacher-password");
        const toggleBtn = document.getElementById("toggle-password");

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          toggleBtn.textContent = "üîí";
          toggleBtn.title = "Masquer le mot de passe";
        } else {
          passwordInput.type = "password";
          toggleBtn.textContent = "üëÅÔ∏è";
          toggleBtn.title = "Afficher le mot de passe";
        }
      }

      // Optimized function to fetch and display section responsables with caching
      let teacherSectionsCache = new Map();
      let sectionsCache = null;

      async function viewSectionResponsables(teacherId) {
        try {
          // Show loading state
          const loadingModal = createLoadingModal();
          document.body.appendChild(loadingModal);

          // First, try to get all available sections to use for lookups
          let allSections = [];
          try {
            const sectionsResponse = await fetch(`${API_BASE_URL}/sections`, {
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
            });

            if (sectionsResponse.ok) {
              const sectionsData = await sectionsResponse.json();
              if (Array.isArray(sectionsData)) {
                allSections = sectionsData;
              } else if (sectionsData && Array.isArray(sectionsData.data)) {
                allSections = sectionsData.data;
              }
              console.log(
                `Loaded ${allSections.length} sections for reference`
              );
            }
          } catch (sectionsError) {
            console.warn(
              "Could not load sections for reference:",
              sectionsError
            );
          }

          // Then fetch the teacher assignments
          const response = await fetch(
            `${API_BASE_URL}/enseignants/${teacherId}/sections-responsable`,
            {
              headers: {
                Authorization: `Bearer ${authToken}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const teacherSections = await response.json();
          console.log("API response for teacher sections:", teacherSections);

          // Format the response data - handle multiple possible response formats
          let formattedSections = [];

          // Add debug log to see what format the API returned
          console.log(
            "Raw teacher sections data structure:",
            JSON.stringify(teacherSections, null, 2)
          );

          if (Array.isArray(teacherSections)) {
            formattedSections = teacherSections.map((resp) => {
              // Handle different possible response formats
              if (resp.section) {
                // Format where section is already a property
                return {
                  section: resp.section,
                  role: resp.role || "enseignant",
                  assignedAt:
                    resp.createdAt ||
                    resp.assignedAt ||
                    new Date().toISOString(),
                };
              } else if (resp.sectionId) {
                // Try to find the section in our allSections array
                const foundSection = allSections.find(
                  (s) => s.id === resp.sectionId
                );

                if (foundSection) {
                  return {
                    section: foundSection,
                    role: resp.role || "enseignant",
                    assignedAt:
                      resp.createdAt ||
                      resp.assignedAt ||
                      new Date().toISOString(),
                  };
                } else {
                  // Fall back to the minimal section data
                  return {
                    section: {
                      id: resp.sectionId,
                      name:
                        resp.sectionName ||
                        `Section ${resp.sectionId.substring(0, 6)}...`,
                      code: resp.sectionCode || "N/A",
                      level: resp.level || "N/A",
                      specialty: resp.specialty || "N/A",
                    },
                    role: resp.role || "enseignant",
                    assignedAt:
                      resp.createdAt ||
                      resp.assignedAt ||
                      new Date().toISOString(),
                  };
                }
              } else {
                // Unknown format - create a default
                return {
                  section: null,
                  role: resp.role || "enseignant",
                  assignedAt:
                    resp.createdAt ||
                    resp.assignedAt ||
                    new Date().toISOString(),
                };
              }
            });
          }

          // Remove loading modal
          document.body.removeChild(loadingModal);

          // Display sections in modal
          displaySectionsModal(formattedSections, teacherId);
        } catch (error) {
          console.error("Error fetching section responsables:", error);
          showMessage("Erreur lors du chargement des sections", "error");
          // Remove loading modal if it exists
          const loadingModal = document.querySelector(".loading-modal");
          if (loadingModal) {
            document.body.removeChild(loadingModal);
          }
        }
      }

      function createLoadingModal() {
        const modal = document.createElement("div");
        modal.className = "modal loading-modal";
        modal.style.display = "block";
        modal.innerHTML = `
          <div class="modal-content" style="text-align: center; padding: 2rem;">
            <div class="loading-spinner" style="margin: 0 auto 1rem auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p>Chargement des sections...</p>
          </div>
        `;
        return modal;
      }

      function displaySectionsModal(teacherSections, teacherId) {
        // Create modal content
        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";
        modalContent.innerHTML = `
          <span class="close-modal">&times;</span>
          <h2>Sections de l'enseignant (${teacherSections.length})</h2>
          <div class="sections-list"></div>
        `;

        // Create modal
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Add optimized styles
        const style = document.createElement("style");
        style.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          .sections-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
          }
          .section-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s ease;
          }
          .section-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
          }
          .section-title {
            font-weight: 600;
            color: var(--primary-color);
          }
          .section-code {
            color: #666;
            font-size: 0.9rem;
          }
          .section-info {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.9rem;
            flex-wrap: wrap;
          }
          .section-info span {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
          }
          .teacher-role {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: space-between;
          }
          .role-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
          }
          .role-title {
            font-weight: 500;
            color: #666;
          }
          .assigned-date {
            font-size: 0.8rem;
            color: #999;
          }
          .empty-sections {
            text-align: center;
            padding: 2rem;
            color: #666;
          }
        `;
        document.head.appendChild(style);

        // Populate sections list
        const sectionsList = modalContent.querySelector(".sections-list");

        if (teacherSections.length === 0) {
          sectionsList.innerHTML = `
            <div class="empty-sections">
              <i class="fas fa-users-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
              <p>Cet enseignant n'est responsable d'aucune section</p>
            </div>
          `;
        } else {
          teacherSections.forEach(({ section, role, assignedAt }) => {
            const sectionItem = document.createElement("div");
            sectionItem.className = "section-item";

            // Check if section exists, if not create a default object
            if (!section) {
              console.warn(
                "Section data missing for teacher assignment, using default values"
              );
              section = {
                name: "Section inconnue",
                code: "N/A",
                level: "N/A",
                specialty: "N/A",
                capacity: null,
              };
            }

            // Clean up section properties (handle variations in property names)
            const sectionName =
              section.name || section.nom || "Section inconnue";
            const sectionCode = section.code || "N/A";
            const sectionLevel = section.level || section.niveau || "N/A";
            const sectionSpecialty =
              section.specialty || section.specialite || "N/A";
            const sectionCapacity =
              section.capacity || section.capacite || "Non d√©finie";

            const roleTitle =
              {
                filiere: "Responsable de Fili√®re",
                section: "Responsable de Section",
                td: "Responsable des TD",
                tp: "Responsable des TP",
              }[role] || role;

            const assignedDate = assignedAt
              ? new Date(assignedAt).toLocaleDateString("fr-FR")
              : "Date inconnue";

            sectionItem.innerHTML = `
              <div class="section-header">
                <div>
                  <div class="section-title">${sectionName}</div>
                  <div class="section-code">${sectionCode}</div>
                </div>
              </div>
              <div class="section-info">
                <span>Niveau: ${sectionLevel}</span>
                <span>Sp√©cialit√©: ${sectionSpecialty}</span>
                <span>Capacit√©: ${sectionCapacity}</span>
              </div>
              <div class="teacher-role">
                <div>
                  <span class="role-badge">${(role || "").toUpperCase()}</span>
                  <span class="role-title">${roleTitle || "R√¥le inconnu"}</span>
                </div>
                <div class="assigned-date">Assign√© le ${assignedDate}</div>
              </div>
            `;

            sectionsList.appendChild(sectionItem);
          });
        }

        // Add close functionality
        const closeBtn = modalContent.querySelector(".close-modal");
        closeBtn.onclick = () => {
          document.body.removeChild(modal);
          document.head.removeChild(style);
        };

        // Show modal
        modal.style.display = "block";

        // Close on outside click
        window.onclick = (event) => {
          if (event.target === modal) {
            document.body.removeChild(modal);
            document.head.removeChild(style);
          }
        };
      }

      // Clear cache when needed
      function clearTeacherSectionsCache() {
        teacherSectionsCache.clear();
        sectionsCache = null;
      }

      // Function to update admin info in the sidebar
      function updateSidebarAdminInfo() {
        const adminName = document.getElementById("admin-name");
        const adminRole = document.getElementById("admin-role");
        const adminAvatar = document.getElementById("admin-avatar");

        // Get admin data from session/local storage
        const adminEmail =
          sessionStorage.getItem("admin_email") ||
          localStorage.getItem("admin_email");
        const adminRoleValue =
          sessionStorage.getItem("admin_role") ||
          localStorage.getItem("admin_role");

        // Extract name from email (e.g., sophie.williams@example.com -> Sophie Williams)
        let displayName = "Admin";
        if (adminEmail) {
          const emailPrefix = adminEmail.split("@")[0];
          // Convert email prefix to display name (sophie.williams -> Sophie Williams)
          displayName = emailPrefix
            .split(".")
            .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
            .join(" ");
        }

        // Map role values to display names
        const roleDisplayNames = {
          doyen: "Doyen",
          "vice-doyen": "Vice-Doyen",
          "chef-de-departement": "Chef de D√©partement",
          "chef-de-specialite": "Chef de Sp√©cialit√©",
          secretaire: "Secr√©taire",
        };

        const displayRole =
          roleDisplayNames[adminRoleValue] ||
          adminRoleValue ||
          "Administrateur";

        // Update the elements
        if (adminName) {
          adminName.textContent = displayName;
        }
        if (adminRole) {
          adminRole.textContent = displayRole;
        }
        if (adminAvatar) {
          adminAvatar.textContent = displayName.charAt(0).toUpperCase();
        }

        // Also try to get from admin_data for backward compatibility
        const adminData = JSON.parse(
          sessionStorage.getItem("admin_data") ||
            localStorage.getItem("admin_data") ||
            "{}"
        );

        if (adminData.name && adminName) {
          adminName.textContent = adminData.name;
        }
        if (adminData.role && adminRole) {
          adminRole.textContent = adminData.role;
        }
        if (adminData.name && adminAvatar) {
          adminAvatar.textContent = adminData.name.charAt(0).toUpperCase();
        }
      }

      // Function to set active menu item in sidebar
      function setSidebarActiveMenuItem() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll(".nav-item");

        navItems.forEach((item) => {
          if (item.getAttribute("href") === currentPath.split("/").pop()) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });
      }
    </script>
  </body>
</html>
