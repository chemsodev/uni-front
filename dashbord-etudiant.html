<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Étudiant</title>
    <link href="style/dashbord-etudiant.css" rel="stylesheet" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div id="navbar-container"></div>
      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h1 class="page-title">Tableau de bord</h1>
          <div class="header-actions">
            <button onclick="window.location.href='emploi.html'">
              Emploi du temps
            </button>
          </div>
        </div>

        <div class="dashboard-cards">
          <!-- Informations Personnelles -->
          <div class="card">
            <h2 class="card-title">Informations Personnelles</h2>
            <div class="card-content" id="personalInfo">
              <div class="info-row">
                <span class="info-label">Nom:</span>
                <span class="info-value" id="lastName"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Prénom:</span>
                <span class="info-value" id="firstName"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Filière:</span>
                <span class="info-value" id="major"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Section:</span>
                <span class="info-value" id="section"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Groupe TD:</span>
                <span class="info-value" id="tdGroup"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Groupe TP:</span>
                <span class="info-value" id="tpGroup"></span>
              </div>
            </div>
          </div>

          <!-- Emploi du temps aujourd'hui -->
          <div class="card">
            <h2 class="card-title">Emploi du temps aujourd'hui</h2>
            <div class="card-content" id="todaySchedule">
              <div class="loading">Chargement...</div>
            </div>
          </div>

          <!-- Demandes -->
          <div class="card">
            <h2 class="card-title">Mes Demandes</h2>
            <div class="card-content" id="requestsList">
              <div class="loading">Chargement...</div>
            </div>
          </div>

          <!-- Notifications -->
          <div class="card">
            <h2 class="card-title">Notifications Récentes</h2>
            <div class="card-content" id="notificationsList">
              <div class="loading">Chargement...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let authToken = null;
      let isBackendAvailable = true; // Flag to track backend availability

      document.addEventListener("DOMContentLoaded", async function () {
        // Load navigation
        fetch("etudiant-nav.html")
          .then((response) => response.text())
          .then((html) => {
            document.getElementById("navbar-container").innerHTML = html;
            // Mark active link after loading
            const navScript = document.createElement("script");
            navScript.innerHTML = `
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                        if(link.getAttribute('href') === '${window.location.pathname
                          .split("/")
                          .pop()}') {
                            link.classList.add('active');
                        }
                    });
                `;
            document.body.appendChild(navScript);
          })
          .catch((error) => {
            console.error("Error loading navigation:", error);
            // Continue without navigation
          });

        try {
          // 1. Retrieve token from storage
          authToken =
            sessionStorage.getItem("etudiant_token") ||
            localStorage.getItem("etudiant_token");

          if (!authToken) {
            window.location.href = "etudiant-login.html";
            return;
          }

          // 2. Verify token and role - with fallback for backend issues
          try {
            const verificationResponse = await fetch(
              "http://localhost:3000/api/auth/verify",
              {
                method: "GET",
                headers: {
                  Authorization: `Bearer ${authToken}`,
                  "Content-Type": "application/json",
                },
                // Add timeout to prevent long waiting
                signal: AbortSignal.timeout(5000),
              }
            );

            if (!verificationResponse.ok) {
              console.warn(
                "Token verification failed but continuing with limited functionality"
              );
              isBackendAvailable = false;
              // Continue with limited functionality instead of redirecting
              loadFallbackData();

              // Add a reconnection button
              addReconnectionButton();
            } else {
              const userData = await verificationResponse.json();

              // 3. Validate student role
              if (userData.adminRole !== "etudiant") {
                throw new Error("Access restricted to students");
              }

              // 4. Set current user
              currentUser = {
                id: userData.userId,
                email: userData.email,
              };

              // 5. Load data
              try {
                await loadUserData();
                await loadDashboardData();
              } catch (dataError) {
                console.error("Error loading data:", dataError);
                isBackendAvailable = false;
                loadFallbackData();
                addReconnectionButton();
              }
            }
          } catch (error) {
            console.error("Auth verification error:", error);
            isBackendAvailable = false;
            loadFallbackData();
            addReconnectionButton();
          }
        } catch (error) {
          console.error("Access denied:", error);
          // Clear storage and redirect
          sessionStorage.removeItem("etudiant_token");
          localStorage.removeItem("etudiant_token");
          window.location.href = "etudiant-login.html";
        }
      });

      // Add reconnection button
      function addReconnectionButton() {
        const offlineNotice = document.querySelector(".alert.alert-warning");

        if (offlineNotice) {
          const reconnectBtn = document.createElement("button");
          reconnectBtn.textContent = "Réessayer la connexion";
          reconnectBtn.style.marginLeft = "10px";
          reconnectBtn.style.padding = "5px 10px";
          reconnectBtn.style.backgroundColor = "#007bff";
          reconnectBtn.style.color = "#fff";
          reconnectBtn.style.border = "none";
          reconnectBtn.style.borderRadius = "4px";
          reconnectBtn.style.cursor = "pointer";

          reconnectBtn.onclick = function () {
            window.location.reload();
          };

          offlineNotice.appendChild(reconnectBtn);
        }
      }

      // Load fallback data when backend is unavailable
      function loadFallbackData() {
        // Add offline mode notice
        const existingNotice = document.querySelector(".alert.alert-warning");
        if (!existingNotice) {
          const offlineNotice = document.createElement("div");
          offlineNotice.className = "alert alert-warning";
          offlineNotice.style.padding = "10px";
          offlineNotice.style.margin = "10px 0";
          offlineNotice.style.backgroundColor = "#fff3cd";
          offlineNotice.style.color = "#856404";
          offlineNotice.style.borderRadius = "4px";
          offlineNotice.innerHTML =
            "<strong>Mode hors ligne:</strong> Le serveur est actuellement indisponible. Certaines fonctionnalités sont limitées.";
          document.querySelector(".main-content").prepend(offlineNotice);
        }

        // Set sample user data
        const sampleUserData = {
          firstName: "Ahmed",
          lastName: "Rahmani",
          matricule: "20230456",
          sections: [
            {
              filiere: "Informatique",
              nom: "B",
              groupe_td: "3",
              groupe_tp: "2",
            },
          ],
        };

        // Update UI with sample data
        document.getElementById("lastName").textContent =
          sampleUserData.lastName;
        document.getElementById("firstName").textContent =
          sampleUserData.firstName;
        document.getElementById("major").textContent =
          sampleUserData.sections[0].filiere;
        document.getElementById("section").textContent =
          sampleUserData.sections[0].nom;
        document.getElementById("tdGroup").textContent =
          sampleUserData.sections[0].groupe_td;
        document.getElementById("tpGroup").textContent =
          sampleUserData.sections[0].groupe_tp;

        // Sample schedule data
        const sampleSchedule = [
          {
            startTime: new Date().setHours(8, 30),
            endTime: new Date().setHours(10, 0),
            courseName: "Algorithmique",
            roomName: "Amphi C",
          },
          {
            startTime: new Date().setHours(10, 15),
            endTime: new Date().setHours(12, 0),
            courseName: "Base de données",
            roomName: "Salle B12",
          },
          {
            startTime: new Date().setHours(14, 0),
            endTime: new Date().setHours(16, 0),
            courseName: "Réseaux",
            roomName: "Labo Info 3",
          },
        ];
        renderTodaySchedule(sampleSchedule);

        // Sample requests data
        const sampleRequests = [
          {
            id: "sample1",
            type: "SECTION_CHANGE",
            createdAt: new Date(Date.now() - 86400000 * 5),
            status: "APPROVED",
          },
          {
            id: "sample2",
            type: "TD_GROUP_CHANGE",
            createdAt: new Date(),
            status: "PENDING",
          },
        ];
        renderRequests(sampleRequests);

        // Sample notifications data
        const sampleNotifications = [
          {
            id: "notif1",
            title: "Note",
            message: "Nouvelle note en Algorithmique",
            createdAt: new Date(Date.now() - 7200000), // 2 hours ago
          },
          {
            id: "notif2",
            title: "Demande",
            message: "Votre demande de changement de section a été approuvée",
            createdAt: new Date(Date.now() - 86400000), // 1 day ago
          },
        ];
        renderNotifications(sampleNotifications);
      }

      // Load user data
      async function loadUserData() {
        try {
          // First try to get the data from localStorage/sessionStorage
          const studentDataJson =
            localStorage.getItem("studentData") ||
            sessionStorage.getItem("studentData");
          let user = null;

          if (studentDataJson) {
            try {
              user = JSON.parse(studentDataJson);
              console.log("Using student data from localStorage");

              // Validate the parsed data has the minimum required fields
              if (
                !user ||
                typeof user !== "object" ||
                (!user.firstName && !user.lastName && !user.matricule)
              ) {
                console.warn(
                  "Invalid student data in localStorage, will fetch from API"
                );
                user = null; // Reset to trigger API fetch
              }
            } catch (e) {
              console.error("Error parsing stored student data:", e);
              // Clear invalid data
              localStorage.removeItem("studentData");
              sessionStorage.removeItem("studentData");
            }
          }

          // If no valid data in storage, fetch from API
          if (!user) {
            const response = await fetch(
              `http://localhost:3000/api/etudiants/${currentUser.id}`,
              {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
                signal: AbortSignal.timeout(5000),
              }
            );

            if (response.ok) {
              user = await response.json();
              // Store the fetched data for future use
              const storage = localStorage.getItem("etudiant_token")
                ? localStorage
                : sessionStorage;
              storage.setItem("studentData", JSON.stringify(user));
            } else {
              // Handle specific error codes
              if (response.status === 401 || response.status === 403) {
                throw new Error(
                  "Accès non autorisé. Veuillez vous reconnecter."
                );
              } else if (response.status === 500) {
                throw new Error(
                  "Erreur serveur. Veuillez réessayer plus tard."
                );
              } else {
                throw new Error("Failed to load user data");
              }
            }
          }

          // Update UI with user data
          document.getElementById("userFullName").textContent =
            `${user.firstName || ""} ${user.lastName || ""}`.trim() ||
            "Utilisateur";
          document.getElementById("userId").textContent =
            user.matricule || "N/A";

          // Add null checks for firstName and lastName
          const firstInitial =
            user.firstName && user.firstName.charAt
              ? user.firstName.charAt(0)
              : "";
          const lastInitial =
            user.lastName && user.lastName.charAt
              ? user.lastName.charAt(0)
              : "";
          document.getElementById("userAvatar").textContent =
            firstInitial && lastInitial
              ? `${firstInitial}${lastInitial}`.toUpperCase()
              : "U";

          // Check if sections array exists and has at least one item
          const hasValidSection =
            user.sections &&
            Array.isArray(user.sections) &&
            user.sections.length > 0;
          const currentSection = hasValidSection ? user.sections[0] : {};

          document.getElementById("lastName").textContent =
            user.lastName || "N/A";
          document.getElementById("firstName").textContent =
            user.firstName || "N/A";

          document.getElementById("major").textContent =
            (currentSection && currentSection.filiere) || "Non assigné";
          document.getElementById("section").textContent =
            (currentSection && currentSection.nom) || "Non assigné";
          document.getElementById("tdGroup").textContent =
            (currentSection && currentSection.groupe_td) || "Non assigné";
          document.getElementById("tpGroup").textContent =
            (currentSection && currentSection.groupe_tp) || "Non assigné";
        } catch (error) {
          console.error("Error loading user data:", error);

          // Check if this is a timeout or network error
          if (
            error.name === "AbortError" ||
            error.message.includes("Failed to fetch")
          ) {
            isBackendAvailable = false;
          }

          // Only load fallback data if not already loaded
          if (document.getElementById("lastName").textContent === "") {
            loadFallbackData();
          }

          // Rethrow to let the caller handle it
          throw error;
        }
      }

      // Load dashboard data
      async function loadDashboardData() {
        try {
          const promises = [];

          // Load today's schedule
          const today = new Date().toISOString().split("T")[0];
          promises.push(
            fetch(
              `http://localhost:3000/api/etudiants/${currentUser.id}/schedule?date=${today}`,
              {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
                signal: AbortSignal.timeout(5000),
              }
            )
              .then((response) => {
                if (response.ok) return response.json();
                return [];
              })
              .then((schedule) => renderTodaySchedule(schedule))
              .catch((error) => {
                console.error("Error loading schedule:", error);
                renderTodaySchedule([]);
              })
          );

          // Load requests
          promises.push(
            fetch(`http://localhost:3000/api/change-requests/my-requests`, {
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
              signal: AbortSignal.timeout(5000),
            })
              .then((response) => {
                if (response.ok) return response.json();
                return [];
              })
              .then((requests) => renderRequests(requests))
              .catch((error) => {
                console.error("Error loading requests:", error);
                renderRequests([]);
              })
          );

          // Load notifications
          promises.push(
            fetch(
              `http://localhost:3000/api/etudiants/${currentUser.id}/notifications`,
              {
                headers: {
                  Authorization: `Bearer ${authToken}`,
                },
                signal: AbortSignal.timeout(5000),
              }
            )
              .then((response) => {
                if (response.ok) return response.json();
                return [];
              })
              .then((notifications) => renderNotifications(notifications))
              .catch((error) => {
                console.error("Error loading notifications:", error);
                renderNotifications([]);
              })
          );

          // Wait for all requests to complete
          await Promise.allSettled(promises);
        } catch (error) {
          console.error("Error loading dashboard data:", error);

          if (!isBackendAvailable) {
            // If backend is unavailable and data hasn't been loaded yet, load fallback data
            if (
              document.getElementById("todaySchedule").querySelector(".loading")
            ) {
              loadFallbackData();
            }
          } else {
            document.getElementById("todaySchedule").innerHTML =
              '<div class="error-message">Erreur de chargement des données</div>';
            document.getElementById("requestsList").innerHTML =
              '<div class="error-message">Erreur de chargement des données</div>';
            document.getElementById("notificationsList").innerHTML =
              '<div class="error-message">Erreur de chargement des données</div>';
          }

          // Rethrow to let the caller handle it
          throw error;
        }
      }

      // Render today's schedule
      function renderTodaySchedule(schedule) {
        const container = document.getElementById("todaySchedule");
        container.innerHTML = "";

        if (schedule.length === 0) {
          container.innerHTML =
            '<div class="empty-state">Aucun cours prévu aujourd\'hui</div>';
          return;
        }

        schedule.forEach((item) => {
          const div = document.createElement("div");
          div.className = "schedule-item";
          div.innerHTML = `
                <strong>${formatTime(item.startTime)} - ${formatTime(
            item.endTime
          )}</strong> -
                ${item.courseName} (${item.roomName})
            `;
          container.appendChild(div);
        });
      }

      // Render requests
      function renderRequests(requests) {
        const container = document.getElementById("requestsList");
        container.innerHTML = "";

        if (requests.length === 0) {
          container.innerHTML =
            '<div class="empty-state">Aucune demande en cours</div>';
          return;
        }

        // Show only the most recent 3 requests
        const recentRequests = requests.slice(0, 3);

        recentRequests.forEach((request) => {
          const div = document.createElement("div");
          div.className = "request-item";
          div.innerHTML = `
                <strong>${getRequestTypeLabel(request.type)}</strong> -
                ${getStatusLabel(request.status)}
                <span class="request-date">(${formatDate(
                  request.createdAt
                )})</span>
            `;
          container.appendChild(div);
        });

        if (requests.length > 3) {
          const moreLink = document.createElement("a");
          moreLink.href = "demandes.html";
          moreLink.className = "more-link";
          moreLink.textContent = "Voir toutes les demandes";
          container.appendChild(moreLink);
        }
      }

      // Render notifications
      function renderNotifications(notifications) {
        const container = document.getElementById("notificationsList");
        container.innerHTML = "";

        if (notifications.length === 0) {
          container.innerHTML =
            '<div class="empty-state">Aucune notification récente</div>';
          return;
        }

        // Show only the most recent 3 notifications
        const recentNotifications = notifications.slice(0, 3);

        recentNotifications.forEach((notif) => {
          const div = document.createElement("div");
          div.className = "notification-item";
          div.innerHTML = `
                <strong>${notif.title}</strong> -
                ${notif.message}
                <span class="notification-time">(${formatTimeAgo(
                  notif.createdAt
                )})</span>
            `;
          container.appendChild(div);
        });

        if (notifications.length > 3) {
          const moreLink = document.createElement("a");
          moreLink.href = "notification.html";
          moreLink.className = "more-link";
          moreLink.textContent = "Voir toutes les notifications";
          container.appendChild(moreLink);
        }
      }

      // Helper functions
      function formatTime(timeString) {
        return new Date(timeString).toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("fr-FR");
      }

      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return "à l'instant";
        if (diffMins < 60) return `il y a ${diffMins} min`;
        if (diffHours < 24) return `il y a ${diffHours}h`;
        if (diffDays < 7) return `il y a ${diffDays}j`;
        return formatDate(dateString);
      }

      function getRequestTypeLabel(type) {
        const types = {
          SECTION_CHANGE: "Changement de Section",
          TD_GROUP_CHANGE: "Changement de Groupe TD",
          TP_GROUP_CHANGE: "Changement de Groupe TP",
          ATTESTATION: "Attestation de scolarité",
          OTHER: "Autre demande",
        };
        return types[type] || type;
      }

      function getStatusLabel(status) {
        const statuses = {
          PENDING: '<span class="status pending">En attente</span>',
          APPROVED: '<span class="status approved">Approuvée</span>',
          REJECTED: '<span class="status rejected">Refusée</span>',
          IN_PROGRESS: '<span class="status in-progress">En cours</span>',
        };
        return statuses[status] || status;
      }

      // Logout function
      async function logout() {
        try {
          if (isBackendAvailable) {
            await fetch("http://localhost:3000/api/auth/logout", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
              signal: AbortSignal.timeout(3000),
            });
          }
        } catch (error) {
          console.error("Logout error:", error);
        } finally {
          // Clear storage and redirect
          sessionStorage.removeItem("etudiant_token");
          localStorage.removeItem("etudiant_token");
          window.location.href = "etudiant-login.html";
        }
      }
    </script>
  </body>
</html>
