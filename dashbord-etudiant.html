<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Étudiant</title>
    <link href="style/dashbord-etudiant.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">AS</div>
                <div class="user-name" id="userFullName">Chargement...</div>
                <div class="user-id" id="userId">Chargement...</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashbord-etudiant.html" class="nav-link active">Tableau de bord</a>
                </li>
                <li class="nav-item">
                    <a href="profile.html" class="nav-link">Profil Personnel</a>
                </li>
                <li class="nav-item">
                    <a href="group-section.html" class="nav-link">Groupe et Section</a>
                </li>
                <li class="nav-item">
                    <a href="demandes.html" class="nav-link">Demandes</a>
                </li>
                <li class="nav-item">
                    <a href="notification.html" class="nav-link">Notifications</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">Déconnexion</a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="page-title">Tableau de bord</h1>
                <div class="header-actions">
                    <button onclick="window.location.href='schedule.html'">Emploi du temps</button>
                </div>
            </div>
            
            <div class="dashboard-cards">
                <!-- Informations Personnelles -->
                <div class="card">
                    <h2 class="card-title">Informations Personnelles</h2>
                    <div class="card-content" id="personalInfo">
                        <p><strong>Nom:</strong> <span id="lastName">Chargement...</span></p>
                        <p><strong>Prénom:</strong> <span id="firstName">Chargement...</span></p>
                        <p><strong>Filière:</strong> <span id="major">Chargement...</span></p>
                        <p><strong>Section:</strong> <span id="section">Chargement...</span></p>
                        <p><strong>Groupe TD:</strong> <span id="tdGroup">Chargement...</span></p>
                        <p><strong>Groupe TP:</strong> <span id="tpGroup">Chargement...</span></p>
                    </div>
                </div>
                
                <!-- Emploi du temps aujourd'hui -->
                <div class="card">
                    <h2 class="card-title">Emploi du temps aujourd'hui</h2>
                    <div class="card-content" id="todaySchedule">
                        <div class="loading-message">Chargement de l'emploi du temps...</div>
                    </div>
                </div>
                
                <!-- Demandes -->
                <div class="card">
                    <h2 class="card-title">Mes Demandes</h2>
                    <div class="card-content" id="requestsList">
                        <div class="loading-message">Chargement des demandes...</div>
                    </div>
                </div>
                
                <!-- Notifications -->
                <div class="card">
                    <h2 class="card-title">Notifications Récentes</h2>
                    <div class="card-content" id="notificationsList">
                        <div class="loading-message">Chargement des notifications...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. Retrieve token from storage
                authToken = sessionStorage.getItem('etudiant_token') || 
                          localStorage.getItem('etudiant_token');
                
                if (!authToken) {
                    window.location.href = 'etudiant-login.html';
                    return;
                }

                // 2. Verify token and role
                const verificationResponse = await fetch('http://localhost:3000/auth/verify', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!verificationResponse.ok) throw new Error('Token verification failed');
                
                const userData = await verificationResponse.json();
                
                // 3. Validate student role
                if (userData.adminRole !== 'etudiant') {
                    throw new Error('Access restricted to students');
                }

                // 4. Set current user
                currentUser = {
                    id: userData.userId,
                    email: userData.email
                };

                // 5. Load data
                loadUserData();
                loadDashboardData();

            } catch (error) {
                console.error('Access denied:', error);
                // Clear storage and redirect
                sessionStorage.removeItem('etudiant_token');
                localStorage.removeItem('etudiant_token');
                window.location.href = 'etudiant-login.html';
            }
        });

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch(`http://localhost:3000/api/etudiants/${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // Update UI
                    document.getElementById('userFullName').textContent = `${user.prenom} ${user.nom}`;
                    document.getElementById('userId').textContent = user.matricule;
                    document.getElementById('userAvatar').textContent = 
                        `${user.prenom.charAt(0)}${user.nom.charAt(0)}`.toUpperCase();
                    
                    document.getElementById('lastName').textContent = user.nom;
                    document.getElementById('firstName').textContent = user.prenom;
                    document.getElementById('major').textContent = user.filiere;
                    document.getElementById('section').textContent = user.section;
                    document.getElementById('tdGroup').textContent = user.groupe_td;
                    document.getElementById('tpGroup').textContent = user.groupe_tp;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load today's schedule
                const today = new Date().toISOString().split('T')[0];
                const scheduleResponse = await fetch(
                    `http://localhost:3000/api/etudiants/${currentUser.id}/emploi-du-temps?date=${today}`, 
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                // Load requests
                const requestsResponse = await fetch(
                    `http://localhost:3000/api/etudiants/${currentUser.id}/demandes`, 
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                // Load notifications
                const notificationsResponse = await fetch(
                    `http://localhost:3000/api/etudiants/${currentUser.id}/notifications`, 
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                // Process responses
                if (scheduleResponse.ok) {
                    const schedule = await scheduleResponse.json();
                    renderTodaySchedule(schedule);
                }

                if (requestsResponse.ok) {
                    const requests = await requestsResponse.json();
                    renderRequests(requests);
                }

                if (notificationsResponse.ok) {
                    const notifications = await notificationsResponse.json();
                    renderNotifications(notifications);
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('http://localhost:3000/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // Clear storage and redirect
                sessionStorage.removeItem('etudiant_token');
                localStorage.removeItem('etudiant_token');
                window.location.href = 'etudiant-login.html';
            }
        }
</script>
</body>
</html>