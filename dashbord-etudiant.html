<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Étudiant</title>
    <link href="style/dashbord-etudiant.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div id="navbar-container"></div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="page-title">Tableau de bord</h1>
                <div class="header-actions">
                    <button onclick="window.location.href='schedule.html'">Emploi du temps</button>
                </div>
            </div>
            
            <div class="dashboard-cards">
                <!-- Informations Personnelles -->
                <div class="card">
                    <h2 class="card-title">Informations Personnelles</h2>
                    <div class="card-content" id="personalInfo">
                        <div class="info-row">
                            <span class="info-label">Nom:</span>
                            <span class="info-value" id="lastName"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prénom:</span>
                            <span class="info-value" id="firstName"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Filière:</span>
                            <span class="info-value" id="major"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Section:</span>
                            <span class="info-value" id="section"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Groupe TD:</span>
                            <span class="info-value" id="tdGroup"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Groupe TP:</span>
                            <span class="info-value" id="tpGroup"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Emploi du temps aujourd'hui -->
                <div class="card">
                    <h2 class="card-title">Emploi du temps aujourd'hui</h2>
                    <div class="card-content" id="todaySchedule"></div>
                </div>

                <!-- Demandes -->
                <div class="card">
                    <h2 class="card-title">Mes Demandes</h2>
                    <div class="card-content" id="requestsList"></div>
                </div>

                <!-- Notifications -->
                <div class="card">
                    <h2 class="card-title">Notifications Récentes</h2>
                    <div class="card-content" id="notificationsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('etudiant-nav.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-container').innerHTML = html;
                // Initialiser les données
                afficherDonnees(); 
                // Marquer le lien actif après chargement
                const navScript = document.createElement('script');
                navScript.innerHTML = `
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                        if(link.getAttribute('href') === '${window.location.pathname.split('/').pop()}') {
                            link.classList.add('active');
                        }
                    });
                `;
                document.body.appendChild(navScript);
            });
    });

    // Récupérer les données depuis localStorage
    const studentData = JSON.parse(localStorage.getItem('studentData'));

    const emploiDuTemps = [
        { heure: "08:30-10:00", cours: "Algorithmique", salle: "Amphi C" },
        { heure: "10:15-12:00", cours: "Base de données", salle: "Salle B12" },
        { heure: "14:00-16:00", cours: "Réseaux", salle: "Labo Info 3" }
    ];

    const demandes = [
        { type: "Attestation de scolarité", statut: "Approuvée", date: "15/10/2023" },
        { type: "Changement de groupe", statut: "En attente", date: "20/10/2023" }
    ];

    const notifications = [
        { titre: "note", details: "Algorithmique", temps: "il y a 2h" },
        { titre: "Demande", details: "Attestation de scolarité", temps: "hier" }
    ];

    function afficherDonnees() {
        // Infos personnelles
        document.getElementById('userAvatar').textContent = 
            studentData.prenom.charAt(0) + studentData.nom.charAt(0);
        document.getElementById('userFullName').textContent = 
            studentData.nom + " " + studentData.prenom;
        document.getElementById('userId').textContent = 
            "Matricule: " + studentData.matricule;
        
        document.getElementById('lastName').textContent = studentData.nom;
        document.getElementById('firstName').textContent = studentData.prenom;
        document.getElementById('major').textContent = studentData.filiere;
        document.getElementById('section').textContent = studentData.section;
        document.getElementById('tdGroup').textContent = studentData.groupeTD;
        document.getElementById('tpGroup').textContent = studentData.groupeTP;

        // Emploi du temps
        const edtElement = document.getElementById('todaySchedule');
        emploiDuTemps.forEach(cours => {
            const div = document.createElement('div');
            div.className = 'schedule-item';
            div.innerHTML = `<strong>${cours.heure}</strong> - ${cours.cours} (${cours.salle})`;
            edtElement.appendChild(div);
        });

        // Demandes
        const demandesElement = document.getElementById('requestsList');
        demandes.forEach(demande => {
            const div = document.createElement('div');
            div.className = 'request-item';
            div.innerHTML = `<strong>${demande.type}</strong> - ${demande.statut} (${demande.date})`;
            demandesElement.appendChild(div);
        });

        // Notifications
        const notifsElement = document.getElementById('notificationsList');
        notifications.forEach(notif => {
            const div = document.createElement('div');
            div.className = 'notification-item';
            div.innerHTML = `<strong>${notif.titre}</strong> - ${notif.details} (${notif.temps})`;
            notifsElement.appendChild(div);
        });
    }

    function logout() {
        localStorage.removeItem('studentData');
        localStorage.removeItem('etudiant_token');
        sessionStorage.removeItem('etudiant_token');
        window.location.href = 'index.html';
    }
        /* Global variables
        let currentUser = null;
        let authToken = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. Retrieve token from storage
                authToken = sessionStorage.getItem('etudiant_token') || 
                          localStorage.getItem('etudiant_token');
                
                if (!authToken) {
                    window.location.href = 'etudiant-login.html';
                    return;
                }

                // 2. Verify token and role
                const verificationResponse = await fetch('https://unicersityback-production.up.railway.app/api/auth/verify', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!verificationResponse.ok) throw new Error('Token verification failed');
                
                const userData = await verificationResponse.json();
                
                // 3. Validate student role
                if (userData.adminRole !== 'etudiant') {
                    throw new Error('Access restricted to students');
                }

                // 4. Set current user
                currentUser = {
                    id: userData.userId,
                    email: userData.email
                };

                // 5. Load data
                loadUserData();
                loadDashboardData();

            } catch (error) {
                console.error('Access denied:', error);
                // Clear storage and redirect
                sessionStorage.removeItem('etudiant_token');
                localStorage.removeItem('etudiant_token');
                window.location.href = 'etudiant-login.html';
            }
        });

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch(`https://unicersityback-production.up.railway.app/api/etudiants/${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // Update UI
                    document.getElementById('userFullName').textContent = `${user.firstName} ${user.lastName}`;
                    document.getElementById('userId').textContent = user.matricule;
                    document.getElementById('userAvatar').textContent = 
                        `${user.firstName.charAt(0)}${user.lastName.charAt(0)}`.toUpperCase();
                    
                    document.getElementById('lastName').textContent = user.lastName;
                    document.getElementById('firstName').textContent = user.firstName;
                    document.getElementById('major').textContent = user.sections[0].filiere;
                    document.getElementById('section').textContent = user.sections[0].nom;
                    document.getElementById('tdGroup').textContent = user.sections[0].groupe_td;
                    document.getElementById('tpGroup').textContent = user.sections[0].groupe_tp;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }


        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load today's schedule
                const today = new Date().toISOString().split('T')[0];
                const scheduleResponse = await fetch(
                    `https://unicersityback-production.up.railway.app/api/etudiants/${currentUser.id}/emploi-du-temps?date=${today}`, 
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                // Load requests
                const requestsResponse = await fetch(
                    `https://unicersityback-production.up.railway.app/api/etudiants/${currentUser.id}/demandes`, 
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                // Load notifications
                const notificationsResponse = await fetch(
                    `https://unicersityback-production.up.railway.app/api                                                                                                                              /etudiants/${currentUser.id}/notifications`, 
                    {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    }
                );

                // Process responses
                if (scheduleResponse.ok) {
                    const schedule = await scheduleResponse.json();
                    renderTodaySchedule(schedule);
                }

                if (requestsResponse.ok) {
                    const requests = await requestsResponse.json();
                    renderRequests(requests);
                }

                if (notificationsResponse.ok) {
                    const notifications = await notificationsResponse.json();
                    renderNotifications(notifications);
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('https://unicersityback-production.up.railway.app/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // Clear storage and redirect
                sessionStorage.removeItem('etudiant_token');
                localStorage.removeItem('etudiant_token');
                window.location.href = 'etudiant-login.html';
            }
        }*/
</script>
</body>
</html>

